
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stratmc.plotting &#8212; StratMC v1.0 Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/stratmc/plotting';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Jul 29, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/stratmc.png" class="logo__image only-light" alt="StratMC v1.0 Manual - Home"/>
    <script>document.write(`<img src="../../_static/stratmc.png" class="logo__image only-dark" alt="StratMC v1.0 Manual - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sedmonsond/stratmc" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/StaceyEdmonsond" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sedmonsond/stratmc" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/StaceyEdmonsond" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">stratmc.plotting</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for stratmc.plotting</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span> <span class="k">as</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

<span class="kn">from</span> <span class="nn">stratmc.data</span> <span class="kn">import</span> <span class="n">accumulation_rate</span><span class="p">,</span> <span class="n">clean_data</span>
<span class="kn">from</span> <span class="nn">stratmc.inference</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">age_range_to_height</span><span class="p">,</span>
    <span class="n">calculate_lengthscale_stability</span><span class="p">,</span>
    <span class="n">calculate_proxy_signal_stability</span><span class="p">,</span>
    <span class="n">count_samples</span><span class="p">,</span>
    <span class="n">find_gaps</span><span class="p">,</span>
    <span class="n">map_ages_to_section</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="proxy_strat">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.proxy_strat">[docs]</a>
<span class="k">def</span> <span class="nf">proxy_strat</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="s1">&#39;d13c&#39;</span><span class="p">,</span> <span class="n">plot_constraints</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_excluded_samples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Plot stratigraphic data (proxy observations and age constraints) for each section.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object</span>
<span class="sd">       from stratmc.plotting import proxy_strat</span>

<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       proxy_strat(sample_df, ages_df, proxy = &#39;d13c&#39;)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Name of proxy. Defaults to &#39;d13c&#39;.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections to plot. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    plot_constraints: bool, optional</span>
<span class="sd">        Whether to plot age constraints as dashed lines. Ages are printed above dashed lines by defalut; to turn off age labels, pass ``print_ages = False``.</span>

<span class="sd">    plot_excluded_samples: bool, optional</span>
<span class="sd">        Whether to plot proxy observations for excluded samples (``Exclude?`` is ``True`` in ``sample_df``) as red dots. Defaults to ``False``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections. Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with observations for each section.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">])][</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;print_ages&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">print_ages</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;print_ages&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_ages</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">4.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_excluded_samples</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)],</span>
                        <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)],</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                        <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">)],</span>
                   <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">)],</span>
                   <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                   <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>


        <span class="n">xl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">plot_constraints</span><span class="p">:</span>
            <span class="n">depositional_age_heights</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">depositional_age_heights</span><span class="p">,</span>
                      <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                      <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                      <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">detrital_age_heights</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">detrital_age_heights</span><span class="p">,</span>
                      <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                      <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
                      <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">intrusive_age_heights</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">intrusive_age_heights</span><span class="p">,</span>
                      <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                      <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span>
                      <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>


        <span class="n">x_range</span> <span class="o">=</span> <span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">print_ages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">age</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">)],</span>
                                          <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">)],</span>
                                          <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age_std&#39;</span><span class="p">][(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">)]):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_range</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">,</span> <span class="c1"># 0.45</span>
                        <span class="n">height</span> <span class="o">+</span> <span class="n">y_range</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">,</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">age</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> Ma&#39;</span><span class="p">,</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">proxy</span> <span class="o">==</span> <span class="s1">&#39;d13c&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\delta^</span><span class="si">{13}</span><span class="s1">$C$_{\mathrm</span><span class="si">{carb}</span><span class="s1">} (‰)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">nbins</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.45</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="proxy_inference">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.proxy_inference">[docs]</a>
<span class="k">def</span> <span class="nf">proxy_inference</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">full_trace</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_constraints</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_excluded_samples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_mean</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_mle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">marker_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">section_legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">section_cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the inferred proxy signal over time.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import proxy_inference</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       proxy_inference(sample_df, ages_df, full_trace, proxy = &#39;d13c&#39;, plot_constraints = True, plot_data = True, plot_excluded_samples = False, section_legend = False, plot_mle = True)</span>

<span class="sd">       plt.show()</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Tracer to plot; only required if more than one proxy was included in the inference.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    plot_constraints: bool, optional</span>
<span class="sd">        Plot age constraints for each section as dashed lines. Defaults to ``False``.</span>

<span class="sd">    plot_data: bool, optional</span>
<span class="sd">        Plot proxy observations by most likely posterior age. Defaults to ``False``.</span>

<span class="sd">    plot_excluded_samples: bool, optional</span>
<span class="sd">        Plot proxy observations that were excluded from the inference (``Exclude?`` is ``True`` in ``sample_df``). Defaults to ``False``.</span>

<span class="sd">    plot_mean: bool, optional</span>
<span class="sd">        Plot the mean as a dashed line. Defaults to ``False``.</span>

<span class="sd">    plot_mle: bool, optional</span>
<span class="sd">        Plot the maximum likelihood estimate. Defaults to ``True``.</span>

<span class="sd">    orientation: str, optional</span>
<span class="sd">        Orientation of figure (&#39;horizontal&#39; with age on the x-axis, or &#39;vertical&#39; with age on the y-axis). Defaults to &#39;horizontal&#39;.</span>

<span class="sd">    marker_size: int, optional</span>
<span class="sd">        Size of markers if ``plot_data`` is ``True``. Defaults to 20.</span>

<span class="sd">    section_legend: bool, optional</span>
<span class="sd">        Include section names in the legend (if ``plot_data`` is ``True``). Defaults to ``False``.</span>

<span class="sd">    section_cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections (if ``plot_data`` is ``True``). Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with the proxy signal inference.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">:</span>
        <span class="n">horizontal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
        <span class="n">horizontal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">])][</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">ages</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">values</span>

    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">section_cmap</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">min_ages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_ages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">plot_data</span><span class="p">:</span> <span class="c1"># by max likelihood</span>
        <span class="n">plotted_excluded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">plotted_data</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>
            <span class="n">proxy_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
            <span class="n">excluded_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])</span>

            <span class="n">sec_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">max_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sec_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sec_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">sample_ages</span> <span class="o">=</span> <span class="n">sec_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sample_ages</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sample_ages</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">max_like</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">sample_ages</span><span class="p">,</span> <span class="n">bw_method</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)(</span><span class="n">dx</span><span class="p">))]</span>

            <span class="k">if</span> <span class="n">section_legend</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">section</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">plotted_data</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely sample age&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend_&#39;</span>

            <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">proxy_idx</span><span class="p">],</span>
                           <span class="n">max_like</span><span class="p">[</span><span class="n">proxy_idx</span><span class="p">],</span>
                           <span class="c1">#np.mean(sec_ages, axis = 1),</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span>
                           <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                           <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

                <span class="n">plotted_data</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">plot_excluded_samples</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">excluded_idx</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotted_excluded</span><span class="p">:</span>
                        <span class="n">excluded_label</span> <span class="o">=</span> <span class="s1">&#39;Excluded samples&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">excluded_label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend&#39;</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">excluded_idx</span><span class="p">],</span>
                           <span class="n">max_like</span><span class="p">[</span><span class="n">excluded_idx</span><span class="p">],</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">excluded_label</span><span class="p">,</span>
                           <span class="n">edgecolors</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

                    <span class="n">plotted_excluded</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="s1">&#39;interp_sample_df&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">interp_sample_df</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;interp_sample_df&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">interp_label</span> <span class="o">=</span> <span class="s1">&#39;Interpolated&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">interp_label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend&#39;</span>
                    <span class="n">interp_sample_df</span> <span class="o">=</span> <span class="n">interp_sample_df</span><span class="p">[</span><span class="n">interp_sample_df</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
                    <span class="n">interp_section_df</span> <span class="o">=</span> <span class="n">interp_sample_df</span><span class="p">[</span><span class="n">interp_sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">interp_section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span>
                           <span class="n">interp_section_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">interp_label</span><span class="p">,</span>
                           <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">max_like</span><span class="p">[</span><span class="n">proxy_idx</span><span class="p">],</span>
                           <span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">proxy_idx</span><span class="p">],</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span>
                           <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

                <span class="n">plotted_data</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">plot_excluded_samples</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">excluded_idx</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotted_excluded</span><span class="p">:</span>
                        <span class="n">excluded_label</span> <span class="o">=</span> <span class="s1">&#39;Excluded samples&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">excluded_label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend&#39;</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">max_like</span><span class="p">[</span><span class="n">excluded_idx</span><span class="p">],</span>
                           <span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">excluded_idx</span><span class="p">],</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">excluded_label</span><span class="p">,</span>
                           <span class="n">edgecolors</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

                    <span class="n">plotted_excluded</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="s1">&#39;interp_sample_df&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">interp_sample_df</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;interp_sample_df&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">interp_label</span> <span class="o">=</span> <span class="s1">&#39;Interpolated&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">interp_label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend&#39;</span>
                    <span class="n">interp_sample_df</span> <span class="o">=</span> <span class="n">interp_sample_df</span><span class="p">[</span><span class="n">interp_sample_df</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
                    <span class="n">interp_section_df</span> <span class="o">=</span> <span class="n">interp_sample_df</span><span class="p">[</span><span class="n">interp_sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">interp_section_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span>
                           <span class="n">interp_section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">interp_label</span><span class="p">,</span>
                           <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">min_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">max_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">proxy_pred</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                         <span class="n">hi</span><span class="p">,</span>
                         <span class="n">lo</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                         <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                         <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                         <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                        <span class="n">hi</span><span class="p">,</span>
                        <span class="n">lo</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                        <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                        <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                         <span class="n">hi</span><span class="p">,</span>
                         <span class="n">lo</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                         <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                         <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                        <span class="n">hi</span><span class="p">,</span>
                        <span class="n">lo</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                        <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_mean</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                   <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Mean &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                   <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Mean &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot_mle</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">max_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">time_slice</span> <span class="o">=</span> <span class="n">proxy_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">max_like</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">time_slice</span><span class="p">,</span> <span class="n">bw_method</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)(</span><span class="n">dy</span><span class="p">))]</span>
        <span class="n">max_like</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">max_like</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">max_like</span><span class="p">,</span>
                    <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_like</span><span class="p">,</span>
                    <span class="n">ages</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>

    <span class="n">xl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">yl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot_constraints</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Age constraint&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span>  <span class="s1">&#39;_nolegend_&#39;</span>
            <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">],</span>
                          <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                          <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                          <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span>
                          <span class="n">zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">],</span>
                          <span class="n">yl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                          <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                          <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span>
                          <span class="n">zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">min_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ages</span><span class="p">))</span>
    <span class="n">max_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ages</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="o">==</span> <span class="s1">&#39;d13c&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\delta^</span><span class="si">{13}</span><span class="s1">$C$_{\mathrm</span><span class="si">{carb}</span><span class="s1">}$ (‰)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_ages</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_ages</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="o">==</span> <span class="s1">&#39;d13c&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\delta^</span><span class="si">{13}</span><span class="s1">$C$_{\mathrm</span><span class="si">{carb}</span><span class="s1">}$ (‰)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_ages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_ages</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span>

<span class="c1">#     for axis in [&#39;top&#39;,&#39;bottom&#39;,&#39;left&#39;,&#39;right&#39;]:</span>
<span class="c1">#         ax.spines[axis].set_linewidth(1.5)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="interpolated_proxy_inference">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.interpolated_proxy_inference">[docs]</a>
<span class="k">def</span> <span class="nf">interpolated_proxy_inference</span><span class="p">(</span><span class="n">interpolated_df</span><span class="p">,</span> <span class="n">interpolated_proxy_df</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_mle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">section_legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">marker_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">section_cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Plot interpolated proxy signal over time (by extending the posterior section age models to a new proxy not included in the inference model) using interpolated age models from :py:meth:`extend_age_model() &lt;stratmc.inference.extend_age_model&gt;` and interpolated proxy values from :py:meth:`interpolate_proxy() &lt;stratmc.inference.interpolate_proxy&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_object, load_trace</span>
<span class="sd">        from stratmc.inference import extend_age_model, interpolate_proxy</span>
<span class="sd">        from stratmc.plotting import interpolated_proxy_inference</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">        example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">        example_sample_path_d18o = str(PROJECT_ROOT) + &#39;/examples/example_sample_df_d18o&#39;</span>
<span class="sd">        example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">        sample_df = load_object(example_sample_path)</span>
<span class="sd">        sample_df_d18o = load_object(example_sample_path_d18o)</span>
<span class="sd">        ages_df = load_object(example_ages_path)</span>

<span class="sd">        interpolated_df = extend_age_model(full_trace, sample_df, ages_df, [&#39;d18o&#39;], new_proxy_df = sample_df_d18o)</span>
<span class="sd">        ages_new = full_trace.X_new.X_new.values.ravel()</span>
<span class="sd">        interpolated_proxy_df = interpolate_proxy(interpolated_df, &#39;d18o&#39;, ages_new)</span>

<span class="sd">        interpolated_proxy_inference(interpolated_df, interpolated_proxy_df, &#39;d18o&#39;)</span>

<span class="sd">        plt.show()</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    interpolated_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` with interpolated age draws and sample age summary statistics from :py:meth:`extend_age_model() &lt;stratmc.inference.extend_age_model&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    interpolated_proxy_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` with interpolated proxy values and summary statistics at target ages from :py:meth:`interpolate_proxy() &lt;stratmc.inference.interpolate_proxy&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str</span>
<span class="sd">        Name of new proxy (must match column name in ``interpolated_proxy_df``).</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    plot_data: bool, optional</span>
<span class="sd">        Plot proxy observations by most likely posterior age. Defaults to ``False``.</span>

<span class="sd">    plot_mle: bool, optional</span>
<span class="sd">        Plot the maximum likelihood estimate. Defaults to ``True``.</span>

<span class="sd">    orientation: str, optional</span>
<span class="sd">        Orientation of figure (&#39;horizontal&#39; or &#39;vertical&#39;). Defaults to &#39;horizontal&#39;.</span>

<span class="sd">    marker_size: int, optional</span>
<span class="sd">        Size of markers if ``plot_data`` is ``True``. Defaults to 20.</span>

<span class="sd">    section_legend: bool, optional</span>
<span class="sd">        Include section names in the legend (if ``plot_data`` is ``True``). Defaults to ``False``.</span>

<span class="sd">    section_cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections (if ``plot_data`` is ``True``). Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with interpolated proxy signal over time.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">interpolated_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">:</span>
        <span class="n">horizontal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
        <span class="n">horizontal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">section_cmap</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">min_ages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_ages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">plot_data</span><span class="p">:</span> <span class="c1"># by max likelihood</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">section_df</span> <span class="o">=</span> <span class="n">interpolated_df</span><span class="p">[</span><span class="n">interpolated_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">section_legend</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">section</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend_&#39;</span>

            <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span>
                           <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span>
                           <span class="c1">#np.mean(sec_ages, axis = 1),</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span>
                           <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                           <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span>
                           <span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span>
                           <span class="n">s</span> <span class="o">=</span> <span class="n">marker_size</span><span class="p">,</span>
                           <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                           <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span>
                           <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                           <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">sec_ages</span> <span class="o">=</span> <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">min_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">))</span>

        <span class="n">max_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span>
                         <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;97.5&#39;</span><span class="p">],</span>
                         <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;2.5&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                         <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                         <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                         <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span>
                        <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;97.5&#39;</span><span class="p">],</span>
                        <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;2.5&#39;</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                        <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                        <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span>
                         <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;84&#39;</span><span class="p">],</span>
                         <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;16&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                         <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                         <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span>
                        <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;84&#39;</span><span class="p">],</span>
                        <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;16&#39;</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                        <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_mle</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span> <span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>

    <span class="n">min_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]))</span>
    <span class="n">max_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">interpolated_proxy_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_ages</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_ages</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_ages</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_ages</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="age_height_model">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.age_height_model">[docs]</a>
<span class="k">def</span> <span class="nf">age_height_model</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">full_trace</span><span class="p">,</span> <span class="n">include_excluded_samples</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a posterior age-height plot for each section.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import age_height_model</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       age_height_model(sample_df, ages_df, full_trace)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections to plot. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections. Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``False``.</span>

<span class="sd">    include_excluded_samples: bool, optional</span>
<span class="sd">        Whether to consider excluded samples (``Exclude?`` is ``True`` in ``sample_df``) whose ages were passively tracked in the inference model. Defaults to ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with age-height models for each section.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">sec_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># posterior_predictive</span>

        <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>

        <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">include_excluded_samples</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;2-$\sigma$&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">included_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">included_idx</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">[</span><span class="n">included_idx</span><span class="p">],</span>
                             <span class="n">lo</span><span class="p">[</span><span class="n">included_idx</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;2-$\sigma$&#39;</span><span class="p">)</span>

        <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span><span class="mi">100</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">include_excluded_samples</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">,</span>
                             <span class="n">lo</span><span class="p">,</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;1-$\sigma$&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">included_idx</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">[</span><span class="n">included_idx</span><span class="p">],</span>
                             <span class="n">lo</span><span class="p">[</span><span class="n">included_idx</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;1-$\sigma$&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_excluded_samples</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                    <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="n">included_idx</span><span class="p">],</span>
                    <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">included_idx</span><span class="p">],</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                    <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span><span class="p">)</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">],</span>
                     <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">],</span>
                     <span class="n">xerr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age_std&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">],</span>
                     <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">section_ages_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][(</span><span class="o">~</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])],</span>
                    <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][(</span><span class="o">~</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])],</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Age ($\pm2\sigma$)&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]],</span>
                        <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]],</span>
                       <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Intrusive Age ($\pm2\sigma$)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]],</span>
                        <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]],</span>
                       <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Detrital Age ($\pm2\sigma$)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span><span class="p">,</span>
                             <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                             <span class="n">markerfirst</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">frameon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="c1">#0.95,  0.985</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span> <span class="c1">## , hspace=0.5</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="section_proxy_signal">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.section_proxy_signal">[docs]</a>
<span class="k">def</span> <span class="nf">section_proxy_signal</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">include_radiometric_ages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_constraints</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">yax</span> <span class="o">=</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map the posterior proxy signal back to height in each section (using its most likely posterior age model), and plot alongside the proxy observations (plotted by most likely posterior age).</span>

<span class="sd">    .. todo::</span>
<span class="sd">        update how interpolation works (see note on map_ages_to_section)</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import section_proxy_signal</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       section_proxy_signal(full_trace, sample_df, ages_df)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    include_radiometric_ages: bool, optional</span>
<span class="sd">        Whether to consider radiometric ages in the posterior age model for each section. Defaults to ``False``.</span>

<span class="sd">    plot_constraints: bool, optional</span>
<span class="sd">        Plot age constraints for each section as dashed lines. Defaults to ``False``.</span>

<span class="sd">    yax: str, optional</span>
<span class="sd">        Scale for the y-axis (&#39;height&#39; or &#39;age&#39;). Defaults to &#39;height&#39;.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections. Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Tracer to plot; only required if more than one proxy was included in the inference.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with inferred proxy signal mapped to height in each section.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># only want to map signal back to sections that actually have data for this proxy</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxy</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">cols</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="n">proxy_pred</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ages_new</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># calculate MLE</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">max_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ages_new</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ages_new</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">time_slice</span> <span class="o">=</span> <span class="n">proxy_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">max_like</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">time_slice</span><span class="p">,</span> <span class="n">bw_method</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)(</span><span class="n">dy</span><span class="p">))]</span>
    <span class="n">max_like</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">max_like</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">mapped_age_models</span> <span class="o">=</span> <span class="n">map_ages_to_section</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span> <span class="n">include_radiometric_ages</span> <span class="o">=</span> <span class="n">include_radiometric_ages</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="c1"># calculate maximum likelihood age for each sample</span>
        <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>

        <span class="n">proxy_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="n">excluded_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])</span>

        <span class="n">section_age_model</span> <span class="o">=</span> <span class="n">mapped_age_models</span><span class="p">[</span><span class="n">mapped_age_models</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>
        <span class="n">section_age_vec</span> <span class="o">=</span> <span class="n">section_age_model</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">above</span> <span class="o">=</span> <span class="p">(</span><span class="n">ages_new</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">section_age_vec</span><span class="p">))</span>
        <span class="n">below</span> <span class="o">=</span> <span class="p">(</span><span class="n">ages_new</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">section_age_vec</span><span class="p">))</span>

        <span class="n">age_idx</span> <span class="o">=</span> <span class="n">above</span> <span class="o">&amp;</span> <span class="n">below</span>

        <span class="c1"># plot data</span>
        <span class="k">if</span> <span class="n">yax</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>

            <span class="c1"># samples included in inference</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">proxy_idx</span><span class="p">],</span>
                        <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">proxy_idx</span><span class="p">],</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                       <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># excluded samples</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">excluded_idx</span><span class="p">],</span>
                        <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">excluded_idx</span><span class="p">],</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                       <span class="n">zorder</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

            <span class="c1"># plot posterior proxy signal</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_age_model</span><span class="p">[</span><span class="s1">&#39;interpolated height&#39;</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">lo</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                             <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_age_model</span><span class="p">[</span><span class="s1">&#39;interpolated height&#39;</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">lo</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                             <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_like</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                    <span class="n">section_age_model</span><span class="p">[</span><span class="s1">&#39;interpolated height&#39;</span><span class="p">],</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely&#39;</span><span class="p">,</span>
                    <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_constraints</span><span class="p">:</span>
                <span class="n">section_ages_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])]</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">proxy</span> <span class="o">==</span> <span class="s1">&#39;d13c&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\delta^</span><span class="si">{13}</span><span class="s1">$C$_{\mathrm</span><span class="si">{carb}</span><span class="s1">}$ (‰)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">yax</span> <span class="o">==</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span>

            <span class="n">sec_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">max_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sec_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sec_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">sample_ages</span> <span class="o">=</span> <span class="n">sec_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sample_ages</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sample_ages</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">max_like</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">sample_ages</span><span class="p">,</span> <span class="n">bw_method</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)(</span><span class="n">dx</span><span class="p">))]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">proxy_idx</span><span class="p">],</span>
                        <span class="n">max_like</span><span class="p">[</span><span class="n">proxy_idx</span><span class="p">],</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                       <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">excluded_idx</span><span class="p">],</span>
                        <span class="n">max_like</span><span class="p">[</span><span class="n">excluded_idx</span><span class="p">],</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
                       <span class="n">zorder</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

            <span class="c1"># plot posterior d13C signal</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ages_new</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">lo</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                             <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">proxy_pred</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ages_new</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">hi</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">lo</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                             <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_like</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                    <span class="n">ages_new</span><span class="p">[</span><span class="n">age_idx</span><span class="p">],</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely&#39;</span><span class="p">,</span>
                    <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_constraints</span><span class="p">:</span>
                <span class="n">section_ages_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])]</span>
                <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">section_ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">proxy</span> <span class="o">==</span> <span class="s1">&#39;d13c&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\delta^</span><span class="si">{13}</span><span class="s1">$C$_{\mathrm</span><span class="si">{carb}</span><span class="s1">}$ (‰)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">n</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">yax</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">yax</span> <span class="o">==</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="covariance_hyperparameters">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.covariance_hyperparameters">[docs]</a>
<span class="k">def</span> <span class="nf">covariance_hyperparameters</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot prior and posterior distributions for the lengthscale (:math:`\\ell`) and variance (:math:`\\sigma`) hyperparameters of the :class:`pymc.gp.cov.ExpQuad &lt;pymc.gp.cov.ExpQuad&gt;` Gaussian process covariance kernel:</span>

<span class="sd">    .. math::</span>

<span class="sd">        k(x, x&#39;) = \\sigma^2 \\mathrm{exp} \\left[-\\frac{(x - x&#39;)^2}{2 \\ell^2} \\right]</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_trace</span>
<span class="sd">       from stratmc.plotting import covariance_hyperparameters</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>

<span class="sd">       covariance_hyperparameters(full_trace)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Tracer to plot model parameters for (each proxy has a different covariance kernel); only required if more than one proxy was included in the inference.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with prior and posterior model parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="s1">&#39;gp_ls_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;indianred&#39;</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span><span class="p">,</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;gp_ls_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;indianred&#39;</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span><span class="p">,</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Lengthscale&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;sci&quot;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="s1">&#39;gp_var_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#87BED5&#39;</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;prior&#39;</span><span class="p">,</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;gp_var_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#87BED5&#39;</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;posterior&#39;</span><span class="p">,</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Variance&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;sci&quot;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="section_summary">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.section_summary">[docs]</a>
<span class="k">def</span> <span class="nf">section_summary</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">full_trace</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">plot_excluded_samples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_noise_prior</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_offset_prior</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">include_age_constraints_sedrate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given section, plot posterior estimates of sample age, sedimentation rate, noise, and offset. Noise and offset terms must be either per-section or global; to plot per-sample noise and offset terms, use :py:meth:`noise_summary() &lt;stratmc.plotting&gt;` and :py:meth:`offset_summary() &lt;stratmc.plotting&gt;`.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import section_summary</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       section_summary(sample_df, ages_df, full_trace, &#39;1&#39;)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    section: str</span>
<span class="sd">        Name of target section.</span>

<span class="sd">    plot_excluded_samples: bool, optional</span>
<span class="sd">        Plot age estimates for proxy observations that were excluded from the inference (``Exclude?`` is ``True`` in ``sample_df``). Defaults to ``False``.</span>

<span class="sd">    plot_noise_prior: bool, optional</span>
<span class="sd">        Plot prior distribution for noise term. Defaults to ``False``.</span>

<span class="sd">    plot_offset_prior: bool, optional</span>
<span class="sd">        Plot prior distribution for offset term. Defaults to ``False``.</span>

<span class="sd">    include_age_constraints_sedrate: bool, optional</span>
<span class="sd">        Include age constraints in sedimentation rate calculations. Defaults to ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure summarizing posterior sample ages, sedimentation rate, and posterior noise and offset terms for the input section.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>


    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_section_noise_&#39;</span> <span class="o">+</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">noise_type</span> <span class="o">=</span> <span class="s1">&#39;section&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">noise_type</span> <span class="o">=</span> <span class="s1">&#39;groups&#39;</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_section_offset_&#39;</span> <span class="o">+</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">offset_type</span> <span class="o">=</span> <span class="s1">&#39;section&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">group_offset_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">l</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_group_offset_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_offset_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offset_type</span> <span class="o">=</span> <span class="s1">&#39;groups&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset_type</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">noise_type</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">offset_type</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">elif</span> <span class="p">((</span><span class="n">noise_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">offset_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">noise_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">offset_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)):</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">elif</span> <span class="p">((</span><span class="n">noise_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">offset_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)):</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)})</span>

    <span class="c1"># link axes with age on the x-axis</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;flare&quot;</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">desat</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="n">pal</span><span class="p">)</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="c1"># posterior_predictive</span>

    <span class="n">sec_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># posterior_predictive</span>

    <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>

    <span class="n">excluded_idx</span> <span class="o">=</span> <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">excluded_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;posterior&#39;</span><span class="p">,</span>
                        <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_excluded_samples</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">sec_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;posterior&#39;</span><span class="p">,</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">edgecolor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">yl</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">],</span>
                 <span class="n">yl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#8c8684&#39;</span><span class="p">,</span>
                 <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                 <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Age constraint&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">])):</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age_std&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                  <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;age_std&#39;</span><span class="p">][</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;#8c8684&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sample ages&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="c1"># age constraint posteriors</span>
    <span class="n">constraint_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_radiometric_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">prior_constraint_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_radiometric_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">constraint_ages</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s1">&#39;crest&#39;</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span>
            <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend&#39;</span>
            <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;_nolegend&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">constraint_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">post_label</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_constraint_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">prior_label</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Age constraints&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># sedimentation rate</span>
    <span class="n">age_bins</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">rate_bins</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="n">rate_df</span> <span class="o">=</span> <span class="n">accumulation_rate</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">section</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;successive&#39;</span><span class="p">,</span> <span class="n">include_age_constraints</span> <span class="o">=</span> <span class="n">include_age_constraints_sedrate</span><span class="p">)</span>

    <span class="n">age_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;top_age&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;base_age&#39;</span><span class="p">]),</span> <span class="n">age_bins</span><span class="p">)</span>

    <span class="n">rate_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">rate_bins</span><span class="p">)</span>

    <span class="c1"># get age bin centers</span>
    <span class="n">age_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">age_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">age_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">age_vec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rate_vec</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">rate</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">],</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;base_age&#39;</span><span class="p">],</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;top_age&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">age_bin_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">age_centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">current_bin</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">age_bin_edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">age_bin_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">current_sample_pair</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">current_bin</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">current_sample_pair</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">age_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
                <span class="n">rate_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>

    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">age_vec</span><span class="p">,</span> <span class="n">rate_vec</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">age_bin_edges</span><span class="p">,</span> <span class="n">rate_bin_edges</span><span class="p">],</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">H</span><span class="p">[</span><span class="n">H</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># each column (age bin) should sum to 1</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;LOG (Accumulation rate [m/Myr])&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Probability density&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

    <span class="c1"># noise posteriors</span>
    <span class="k">if</span> <span class="n">noise_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">noise_type</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>
            <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">noise_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>
            <span class="n">palettes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;crest&#39;</span><span class="p">,</span> <span class="s1">&#39;flare&#39;</span><span class="p">,</span> <span class="s1">&#39;Purples&#39;</span><span class="p">,</span> <span class="s1">&#39;Grays&#39;</span><span class="p">,</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="s1">&#39;YlOrBr&#39;</span><span class="p">,</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">)):</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">noise_type</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>

                <span class="n">posterior_noise_dist</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_section_noise_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">prior_noise_dist</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_section_noise_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">posterior_noise_dist</span><span class="p">,</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39; posterior&#39;</span><span class="p">,</span>
                            <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">plot_noise_prior</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_noise_dist</span><span class="p">,</span>
                                <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39; prior&#39;</span><span class="p">,</span>
                                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">noise_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>

                <span class="n">noise_vars</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">l</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_group_noise_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
                <span class="p">]</span>

                <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">palettes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_vars</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">noise_vars</span><span class="p">):</span>
                    <span class="n">posterior_noise_dist</span> <span class="o">=</span>  <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">posterior_noise_dist</span><span class="p">,</span>
                                    <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                    <span class="n">label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39; posterior&#39;</span><span class="p">,</span>
                                    <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">plot_noise_prior</span><span class="p">:</span>
                        <span class="n">prior_noise_dist</span> <span class="o">=</span>  <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_noise_dist</span><span class="p">,</span>
                                    <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                    <span class="n">label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39; prior&#39;</span><span class="p">,</span>
                                    <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">noise_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Noise&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># offset posteriors</span>
    <span class="k">if</span> <span class="n">offset_type</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">offset_type</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>
            <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">offset_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>
            <span class="n">palettes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;crest&#39;</span><span class="p">,</span> <span class="s1">&#39;flare&#39;</span><span class="p">,</span> <span class="s1">&#39;Purples&#39;</span><span class="p">,</span> <span class="s1">&#39;Grays&#39;</span><span class="p">,</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="s1">&#39;YlOrBr&#39;</span><span class="p">,</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">)):</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">offset_type</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>
                <span class="n">posterior_offset_dist</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_section_offset_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">posterior_offset_dist</span><span class="p">,</span>
                                <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39; posterior&#39;</span><span class="p">,</span>
                                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">plot_offset_prior</span><span class="p">:</span>
                    <span class="n">prior_offset_dist</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_section_offset_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_offset_dist</span><span class="p">,</span>
                                    <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                    <span class="n">label</span> <span class="o">=</span> <span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39; prior&#39;</span><span class="p">,</span>
                                    <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">offset_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>

                <span class="n">offset_vars</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">l</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_group_offset_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
                <span class="p">]</span>

                <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">palettes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_vars</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">offset_vars</span><span class="p">):</span>

                    <span class="n">posterior_offset_dist</span> <span class="o">=</span>  <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">posterior_offset_dist</span><span class="p">,</span>
                                <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39; posterior&#39;</span><span class="p">,</span>
                                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>


                    <span class="k">if</span> <span class="n">plot_offset_prior</span><span class="p">:</span>
                        <span class="n">prior_offset_dist</span> <span class="o">=</span>  <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_offset_dist</span><span class="p">,</span>
                                <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39; prior&#39;</span><span class="p">,</span>
                                <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Offset&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Section: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="noise_summary">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.noise_summary">[docs]</a>
<span class="k">def</span> <span class="nf">noise_summary</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot posterior noise distributions for each section or group of samples (depending on ``noise_type`` used in :py:meth:`build_model() &lt;stratmc.model.build_model&gt;`) for a given proxy. If multiple proxies were included in the inference, pass a ``proxy`` argument to specify which noise terms to plot.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import noise_summary</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       sections = np.unique(sample_df[&#39;section&#39;].values)</span>

<span class="sd">       noise_summary(full_trace)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Target proxy; only required if more than one proxy was included in the inference.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with noise distributions for each section or group of samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">section_noise_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_section_noise_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
            <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">section_noise_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_vars</span> <span class="o">=</span> <span class="n">section_noise_vars</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">noise_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_group_noise_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No noise terms in the model&quot;</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_vars</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="p">]))</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_vars</span><span class="p">))</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">noise_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">posterior_noise_dist</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">posterior_noise_dist</span><span class="p">,</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">,</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Noise (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="offset_summary">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.offset_summary">[docs]</a>
<span class="k">def</span> <span class="nf">offset_summary</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Plot posterior offset distributions for each section or group of samples (depending on ``offset_type`` used in :py:meth:`build_model() &lt;stratmc.model.build_model&gt;`). If multiple proxies were included in the inference, pass a ``proxy`` argument to specify which offset terms to plot.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import offset_summary</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>

<span class="sd">       offset_summary(full_trace)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Target proxy; only required if more than one proxy was included in the inference.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with offset distributions for each section or group of samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">section_offset_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">l</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_section_offset_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">section_offset_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">offset_vars</span> <span class="o">=</span> <span class="n">section_offset_vars</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">l</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_group_offset_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No offset terms in the model&quot;</span><span class="p">)</span>


    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_vars</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="p">]))</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_vars</span><span class="p">))</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">offset_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="c1"># shape = samples x draws</span>
        <span class="n">posterior_offset_dist</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">posterior_offset_dist</span><span class="p">,</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                        <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">var</span><span class="p">,</span>
                        <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>


    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Offset (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="section_proxy_residuals">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.section_proxy_residuals">[docs]</a>
<span class="k">def</span> <span class="nf">section_proxy_residuals</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">include_excluded_samples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Plot the residuals between the observed proxy values for each section and the inferred proxy signal (using the posterior section age models to map the signal back to height in section). Use to check for stratigraphic trends in the residuals, which may give insight to the processes that cause noisy sections to deviate from the inferred common signal. If multiple proxies were included in the inference, pass a ``proxy`` argument.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        should this function (optionally) correct for the inferred offset before calulating the residuals? so that residuals just represent noise that cannot be explained as a constant offset</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import section_proxy_residuals</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>

<span class="sd">       section_proxy_residuals(full_trace, sample_df)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections. Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Target proxy; only required if more than one proxy was included in the inference.</span>

<span class="sd">    include_excluded_samples: bool, optional</span>
<span class="sd">        Whether to plot the residuals for samples that were excluded from the inference (``Exclude?`` is ``True`` in ``sample_df``). Defaults to ``False``.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with residuals for each section.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">])][</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>


    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">cols</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="n">proxy_pred</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ages_new</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">section_sample_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">include_excluded_samples</span><span class="p">:</span>
            <span class="n">included_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">section_sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">included_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">section_sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">section_sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])</span>

        <span class="n">section_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">included_idx</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">section_proxy_true</span> <span class="o">=</span> <span class="n">section_sample_df</span><span class="p">[</span><span class="n">included_idx</span><span class="p">][</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">section_heights</span> <span class="o">=</span> <span class="n">section_sample_df</span><span class="p">[</span><span class="n">included_idx</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">section_proxy_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">section_proxy_true</span><span class="p">),</span> <span class="n">proxy_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">section_residuals</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">section_proxy_true</span><span class="p">),</span> <span class="n">proxy_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">proxy_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">section_proxy_pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">section_ages</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ages_new</span><span class="p">,</span> <span class="n">proxy_pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="c1"># residual = actual - predicted</span>
            <span class="n">section_residuals</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_proxy_true</span> <span class="o">-</span> <span class="n">section_proxy_pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">section_residuals</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">section_residuals</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_heights</span><span class="p">,</span>
                             <span class="n">hi</span><span class="p">,</span>
                             <span class="n">lo</span><span class="p">,</span>
                             <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">,</span><span class="mf">.95</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                             <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">section_residuals</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">section_residuals</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">section_heights</span><span class="p">,</span>
                         <span class="n">hi</span><span class="p">,</span>
                         <span class="n">lo</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.8</span><span class="p">),</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">,</span>
                         <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
                         <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                         <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># calculate mle</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">section_residuals</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">section_residuals</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">max_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">section_heights</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">section_heights</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">height_slice</span> <span class="o">=</span> <span class="n">section_residuals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">max_like</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">height_slice</span><span class="p">,</span> <span class="n">bw_method</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)(</span><span class="n">dy</span><span class="p">))]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_like</span><span class="p">,</span>
                <span class="n">section_heights</span><span class="p">,</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Residual &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; value (observed - predicted)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="sample_ages">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.sample_ages">[docs]</a>
<span class="k">def</span> <span class="nf">sample_ages</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">plot_excluded_samples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot sample age prior and posterior distributions for a given section. Each subplot contains posterior distributions for a different sample.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import sample_ages</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       section = &#39;1&#39;</span>

<span class="sd">       sample_ages(full_trace, sample_df, section)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    section: str</span>
<span class="sd">        Name of target section.</span>

<span class="sd">    plot_excluded_samples: bool, optional</span>
<span class="sd">        Plot age distributions for proxy observations that were excluded from the inference (``Exclude?`` is ``True`` in ``sample_df``). Defaults to ``False``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for age distributions. Defaults to &#39;viridis&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with prior and posterior sample age distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">prior_vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_excluded_samples</span><span class="p">:</span>
        <span class="n">included_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># shape = (samples x draws)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">included_idx</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">excluded_idx</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="n">excluded_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot_excluded_samples</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">excluded_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior (excluded sample)&#39;</span>
                <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior (excluded sample)&#39;</span>
                <span class="n">excluded_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span>
                <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
            <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span>
            <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">post_label</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_vals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">prior_label</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">excluded_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">excluded_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Section: &#39;</span> <span class="o">+</span> <span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="sample_ages_per_chain">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.sample_ages_per_chain">[docs]</a>
<span class="k">def</span> <span class="nf">sample_ages_per_chain</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">chains</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_prior</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_excluded_samples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot sample age posterior distributions for a given section, with separate distributions for each chain. Each subplot contains posterior distributions for a different sample. Use to check for posterior multimodality (in this example, each chain has explored a different mode of the posterior age distributions).</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import sample_ages_per_chain</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       section = &#39;1&#39;</span>

<span class="sd">       sample_ages_per_chain(full_trace, sample_df, section, chains = [0, 1, 2, 3])</span>

<span class="sd">       plt.show()</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    section: str</span>
<span class="sd">        Name of target section.</span>

<span class="sd">    chains: list(int) or numpy.array(int); optional</span>
<span class="sd">        Indices of chains to include; optional (defaults to all chains).</span>

<span class="sd">    plot_prior: bool, optional</span>
<span class="sd">        Plot prior distributions for sample ages. Defaults to ``False``.</span>

<span class="sd">    plot_excluded_samples: bool, optional</span>
<span class="sd">        Plot age distributions for proxy observations that were excluded from the inference (``Exclude?`` is ``True`` in ``sample_df``). Defaults to ``False``.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for different chains. Defaults to &#39;viridis&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with per-chain posterior sample age distributions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>

    <span class="c1"># chains x draws x samples</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">chains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">prior_vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_excluded_samples</span><span class="p">:</span>
        <span class="n">included_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># shape = (samples x draws)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">included_idx</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">excluded_idx</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="n">excluded_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot_excluded_samples</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">excluded_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span>
                <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior (excluded sample)&#39;</span>
                <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior (excluded sample)&#39;</span>
                <span class="n">excluded_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
                <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span>
                <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
            <span class="n">post_label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span>
            <span class="n">prior_label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">)):</span>
            <span class="n">cs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

            <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">post_label</span> <span class="o">+</span> <span class="s1">&#39;, chain &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chains</span><span class="p">[</span><span class="n">m</span><span class="p">]),</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="n">lw</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_prior</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_vals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">prior_label</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">excluded_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">excluded_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Section: &#39;</span> <span class="o">+</span> <span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="age_constraints">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.age_constraints">[docs]</a>
<span class="k">def</span> <span class="nf">age_constraints</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    For a given section, plot prior and posterior age distributions for all depositional age constraints (and limiting age constraints that provide a minimum or maximum age for the entire section). To plot intermediate limiting ages (i.e., detrital and intrusive age constraints in the middle of a section), use :py:meth:`limiting_age_constraints() &lt;stratmc.plotting.limiting_age_constraints&gt;`.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_trace</span>
<span class="sd">       from stratmc.plotting import age_constraints</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       section = &#39;1&#39;</span>

<span class="sd">       age_constraints(full_trace, section)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    section: str</span>
<span class="sd">        Name of target section.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for age distributions. Defaults to &#39;viridis&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with prior and posterior depositional age constraint distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_radiometric_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">prior_vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_radiometric_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># if only 1 age constraint (should only occur if one the min or max age is shared), reshape for plotting</span>
    <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">prior_vals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prior_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">prior_vals</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_vals</span><span class="p">)))</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="n">samples</span><span class="p">])</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_vals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Section: &#39;</span> <span class="o">+</span> <span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="limiting_age_constraints">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.limiting_age_constraints">[docs]</a>
<span class="k">def</span> <span class="nf">limiting_age_constraints</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given section, plot prior and posterior age distributions for all intermediate limiting (i.e., detrital and intrusive ages in the middle of a section) age constraints. To plot depositional age constraints (and limiting age constraints that provide a minimum or maximum age for the entire section), use :py:meth:`age_constraints() &lt;stratmc.plotting.age_constraints&gt;`.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_object, load_trace</span>
<span class="sd">        from stratmc.plotting import limiting_age_constraints</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_limiting_ages_trace&#39;)</span>
<span class="sd">        example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df_limiting_ages&#39;</span>
<span class="sd">        example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df_limiting_ages&#39;</span>
<span class="sd">        sample_df = load_object(example_sample_path)</span>
<span class="sd">        ages_df = load_object(example_ages_path)</span>
<span class="sd">        section = &#39;1&#39;</span>

<span class="sd">        limiting_age_constraints(full_trace, sample_df, ages_df, section)</span>

<span class="sd">        plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    section: str</span>
<span class="sd">        Name of target section.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for age distributions. Defaults to &#39;viridis&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with prior and posterior limiting age constraint distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="p">[</span><span class="n">section</span><span class="p">])</span>

    <span class="n">detrital_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])]</span>
    <span class="n">intrusive_df</span> <span class="o">=</span>  <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])]</span>

    <span class="n">detrital_named</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">detrital_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># grab names from list of model variables (will only include constriants that aren&#39;t shared)</span>
        <span class="n">detrital_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">section</span><span class="p">)]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;detrital_age_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">detrital_named</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">detrital_vars</span><span class="p">)</span>

        <span class="c1"># if constraints are shared, grab those names too</span>
        <span class="n">detrital_vars</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">detrital_df</span><span class="p">[</span><span class="n">detrital_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">detrital_named</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">detrital_df</span><span class="p">[</span><span class="n">detrital_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">detrital_vars</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">intrusive_named</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">intrusive_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="c1"># grab names from list of model variables (will only include constriants that aren&#39;t shared)</span>
        <span class="n">intrusive_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">section</span><span class="p">)]</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;intrusive_age_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">intrusive_named</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">intrusive_vars</span><span class="p">)</span>

        <span class="c1"># if constraints are shared, grab those names too</span>
        <span class="n">intrusive_vars</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intrusive_df</span><span class="p">[</span><span class="n">intrusive_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">intrusive_named</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">intrusive_df</span><span class="p">[</span><span class="n">intrusive_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">intrusive_vars</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># number of age constraints to plot</span>
    <span class="n">combined_vars</span> <span class="o">=</span> <span class="n">detrital_vars</span> <span class="o">+</span> <span class="n">intrusive_vars</span>
    <span class="n">combined_named</span> <span class="o">=</span> <span class="n">detrital_named</span> <span class="o">+</span> <span class="n">intrusive_named</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2"> has no intermediate limiting age constraints&quot;</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_vars</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">combined_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">named</span> <span class="o">=</span> <span class="n">combined_named</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">named</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">detrital_vars</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Detrital &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Intrusive &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">detrital_vars</span><span class="p">))</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="c1"># distributions for detrital and intrsive ages are always 1d (different objects created for each constraint)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">prior_vals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Posterior&#39;</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">prior_vals</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Section: &#39;</span> <span class="o">+</span> <span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="sadler_plot">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.sadler_plot">[docs]</a>
<span class="k">def</span> <span class="nf">sadler_plot</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">duration_bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">rate_bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">include_age_constraints</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">density_cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">section_cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot accumulation rate against duration.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import sadler_plot</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       sadler_plot(full_trace, sample_df, ages_df)</span>

<span class="sd">       plt.show()</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    method: str, optional</span>
<span class="sd">        Plot as a 2D histogram (&#39;density&#39;) or as a scatter plot (&#39;scatter&#39;). The density plot will combine data for all sections in ``sections``, while a scatter plot will assign a unique color to each section. Defaults to &#39;density&#39;.</span>

<span class="sd">    duration_bins: int, optional</span>
<span class="sd">        Number of bin edges to use for the duration data. Defaults to 50.</span>

<span class="sd">    rate_bins: int, optional</span>
<span class="sd">        Number of bin edges to use for the rate data. Defaults to 50.</span>

<span class="sd">    scale: str, optional</span>
<span class="sd">        Scaling for x- and y-axes (&#39;linear&#39; or &#39;log&#39;). Defaults to &#39;log&#39;.</span>

<span class="sd">    sections: list(str) numpy.array(str), optional</span>
<span class="sd">        List of target sections. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    include_age_constraints: bool, optional</span>
<span class="sd">        Include age constraints in sedimentation rate calculations. Defaults to ``False``.</span>

<span class="sd">    density_cmap: str, optional</span>
<span class="sd">        Name of matplotlib colormap to use for probability density if ``method`` is &#39;density`. Defaults to &#39;jet&#39;.</span>

<span class="sd">    section_cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections if ``method`` is &#39;scatter`. Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with sediment accumulation rate plotted against duration.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># any sections that have no relevant proxy observations would not have ages tracked in the trace</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">rate_df</span> <span class="o">=</span> <span class="n">accumulation_rate</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span> <span class="n">include_age_constraints</span> <span class="o">=</span> <span class="n">include_age_constraints</span><span class="p">)</span>

    <span class="n">dur</span> <span class="o">=</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;density&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">x_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dur</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dur</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">duration_bins</span><span class="p">)</span>
            <span class="n">y_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rate</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rate</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">rate_bins</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dur</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dur</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">duration_bins</span><span class="p">)</span>
            <span class="n">y_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rate</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">rate</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">rate_bins</span><span class="p">)</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">dur</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">x_bins</span><span class="p">,</span> <span class="n">y_bins</span><span class="p">],</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># don&#39;t normalize during this step - calculation not correct if scale = log</span>

        <span class="n">H</span><span class="p">[</span><span class="n">H</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span> <span class="c1"># normalize</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">density_cmap</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Probability density&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span>
        <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">section_cmap</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)):</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rate_df</span><span class="p">[</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                       <span class="n">s</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                       <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                      <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                      <span class="n">label</span> <span class="o">=</span> <span class="n">section</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;LOG (Duration [yr])&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;LOG (Accumulation rate [mm/yr])&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Duration (yr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accumulation rate (mm/yr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="accumulation_rate_stratigraphy">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.accumulation_rate_stratigraphy">[docs]</a>
<span class="k">def</span> <span class="nf">accumulation_rate_stratigraphy</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">age_bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">age_bin_edges</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">rate_bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">rate_bin_edges</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">rate_scale</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">include_age_constraints</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the probability density of sediment accumulation rates (calculated between successive samples) through time. Probability density for each age bin sums to 1. Unless a ``sections`` argument is passed, includes accumulation rates for all sections.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import accumulation_rate_stratigraphy</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       accumulation_rate_stratigraphy(full_trace, sample_df, ages_df, sections = [&#39;1&#39;])</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    age_bins: int, optional</span>
<span class="sd">        Number of bin edges for age data (if ``age_bin_edges`` not provided). Defaults to 50.</span>

<span class="sd">    rate_bins: int, optional</span>
<span class="sd">        Number of bin edges for rate data (if ``rate_bin_edges`` not provided). Defaults to 50.</span>

<span class="sd">    age_bin_edges: list(float) or numpy.array(float), optional</span>
<span class="sd">        List or array of bin edges for the age data.</span>

<span class="sd">    rate_bin_edges: list(float) numpy.array(float), optional</span>
<span class="sd">        List or array of bin edges for the rate data.</span>

<span class="sd">    rate_scale: str, optional</span>
<span class="sd">        Scaling for rate (&#39;linear&#39; or &#39;log&#39;). Defaults to &#39;log&#39;.</span>

<span class="sd">    include_age_constraints: bool, optional</span>
<span class="sd">        Include age constraints in sedimentation rate calculations. Defaults to ``True``.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        Section(s) to include. If not provided, combines data from all sections in ``sample_df``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with accumulation rate probability density through time.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">rate_df</span> <span class="o">=</span> <span class="n">accumulation_rate</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;successive&#39;</span><span class="p">,</span> <span class="n">include_age_constraints</span> <span class="o">=</span> <span class="n">include_age_constraints</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">age_bin_edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">age_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;top_age&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;base_age&#39;</span><span class="p">]),</span> <span class="n">age_bins</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rate_bin_edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rate_scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">rate_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">rate_bins</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rate_scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">rate_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">rate_bins</span><span class="p">)</span>

    <span class="c1"># get age bin centers</span>
    <span class="n">age_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">age_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">age_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">age_vec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rate_vec</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">rate</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">],</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;base_age&#39;</span><span class="p">],</span> <span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;top_age&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">age_bin_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">age_centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">current_bin</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">age_bin_edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">age_bin_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">current_sample_pair</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">current_bin</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">current_sample_pair</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">age_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
                <span class="n">rate_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">age_vec</span><span class="p">,</span> <span class="n">rate_vec</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">age_bin_edges</span><span class="p">,</span> <span class="n">rate_bin_edges</span><span class="p">],</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">H</span><span class="p">[</span><span class="n">H</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># each column (age bin) should sum to 1</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rate_scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;LOG (Accumulation rate [m/Myr])&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">rate_scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accumulation rate (m/Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Probability density&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="section_age_range">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.section_age_range">[docs]</a>
<span class="k">def</span> <span class="nf">section_age_range</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">lower_age</span><span class="p">,</span> <span class="n">upper_age</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">section_cmap</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the stratigraphic interval corresponding to a given age range (based on the posterior section age models). If ``sections`` is not provided, includes each section that overlaps the target age range.</span>

<span class="sd">    .. plot::</span>

<span class="sd">       from stratmc.config import PROJECT_ROOT</span>
<span class="sd">       from stratmc.data import load_object, load_trace</span>
<span class="sd">       from stratmc.plotting import section_age_range</span>

<span class="sd">       full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace&#39;)</span>
<span class="sd">       example_sample_path = str(PROJECT_ROOT) + &#39;/examples/example_sample_df&#39;</span>
<span class="sd">       example_ages_path = str(PROJECT_ROOT) + &#39;/examples/example_ages_df&#39;</span>
<span class="sd">       sample_df = load_object(example_sample_path)</span>
<span class="sd">       ages_df = load_object(example_ages_path)</span>

<span class="sd">       section_age_range(full_trace, sample_df, ages_df, 120, 130)</span>

<span class="sd">       plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    lower_age: float</span>
<span class="sd">        Lower bound (youngest) of the target age interval.</span>

<span class="sd">    upper_age: float</span>
<span class="sd">        Upper bound (oldest) of the target age interval.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    cmap: str, optional</span>
<span class="sd">        Name of seaborn color palette to use for sections. Defaults to &#39;Spectral&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Tracer stratigraphy for each section, with the stratigraphic interval corresponding to the input age range highlighted.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">stats_df</span> <span class="o">=</span> <span class="n">age_range_to_height</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span><span class="n">lower_age</span><span class="p">,</span> <span class="n">upper_age</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">sections</span> <span class="o">=</span> <span class="n">stats_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">section_cmap</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">))</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">cols</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">4.5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">section_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span> <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># 0 is the top height, -1 is the bottom height</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;base_2.5&#39;</span><span class="p">],</span> <span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;top_97.5&#39;</span><span class="p">],</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;base_16&#39;</span><span class="p">],</span> <span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;top_84&#39;</span><span class="p">],</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;68</span><span class="si">% e</span><span class="s1">nvelope&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;base_mle&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;top_mle&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Most likely range&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="o">==</span> <span class="s1">&#39;d13c&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\delta^</span><span class="si">{13}</span><span class="s1">$C$_{\mathrm</span><span class="si">{carb}</span><span class="s1">} (‰)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="proxy_data_gaps">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.proxy_data_gaps">[docs]</a>
<span class="k">def</span> <span class="nf">proxy_data_gaps</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">yaxis</span> <span class="o">=</span> <span class="s1">&#39;percentage&#39;</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a set of discrete time bins, shows the number of draws from the posterior where there are no proxy observations (i.e., where there are temporal `gaps` in the proxy data). This plot can be used to determine where additional observations are needed to improve the inference.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_trace</span>
<span class="sd">        from stratmc.plotting import proxy_data_gaps</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace_data_density&#39;)</span>

<span class="sd">        proxy_data_gaps(full_trace)</span>

<span class="sd">        plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    time_grid: np.array, optional</span>
<span class="sd">        Time bin edges; if not provided, defaults to the ``ages`` array passed to :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;`.</span>

<span class="sd">    yaxis: str, optional</span>
<span class="sd">        Set y-axis to percentage of posterior draws without observations (&#39;percentage&#39;) or to the number of posterior draws without observations (&#39;count`). Defaults to &#39;percentage`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with bar plot of number of posterior draws with gaps for each time bin.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">if</span> <span class="n">time_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_grid</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">values</span>

    <span class="n">age_gaps</span><span class="p">,</span> <span class="n">grid_centers</span><span class="p">,</span> <span class="n">grid_widths</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span>  <span class="n">find_gaps</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">time_grid</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">yaxis</span> <span class="o">==</span> <span class="s1">&#39;percentage&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">grid_centers</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">age_gaps</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">grid_widths</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">olutions without observations&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">yaxis</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">grid_centers</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">age_gaps</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">grid_widths</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;# solutions without observations&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="proxy_data_density">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.proxy_data_density">[docs]</a>
<span class="k">def</span> <span class="nf">proxy_data_density</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the mean number proxy observations in discrete time bins (averaged over all posterior draws). This plot can be used to determine where proxy observations are relatively sparse, and additional observations may improve the inference.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_trace</span>
<span class="sd">        from stratmc.plotting import proxy_data_density</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace_data_density&#39;)</span>

<span class="sd">        proxy_data_density(full_trace)</span>

<span class="sd">        plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    time_grid: np.array, optional</span>
<span class="sd">        Time bin edges; if not provided, defaults to the ``ages`` array passed to :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with bar plot of mean number of observations in each time bin.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">if</span> <span class="n">time_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_grid</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">X_new</span><span class="o">.</span><span class="n">values</span>

    <span class="n">sample_counts</span><span class="p">,</span> <span class="n">grid_centers</span><span class="p">,</span> <span class="n">grid_widths</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span>  <span class="n">count_samples</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">time_grid</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">grid_centers</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">sample_counts</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">grid_widths</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average # observations&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age (Ma)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="lengthscale_traceplot">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.lengthscale_traceplot">[docs]</a>
<span class="k">def</span> <span class="nf">lengthscale_traceplot</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">chains</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate trace plot (parameter value vs. step in Markov chain) for the :class:`pymc.gp.cov.ExpQuad &lt;pymc.gp.cov.ExpQuad&gt;` covariance kernel lengthscale. By default, includes all chains; to plot the draws for only a subset of chains, past list of chain indices to ``chains``. Use to check for posterior multimodality.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_trace</span>
<span class="sd">        from stratmc.plotting import lengthscale_traceplot</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace_convergence&#39;)</span>

<span class="sd">        lengthscale_traceplot(full_trace, chains = [0, 1, 2, 3])</span>

<span class="sd">        plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    chains: list(int) or numpy.array(int); optional</span>
<span class="sd">        Indices of chains to plot; optional (defaults to all chains).</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Target proxy; only required if more than one proxy was included in the inference.</span>

<span class="sd">    legend: bool, optional</span>
<span class="sd">        Generate a legend. Defaults to ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure with lengthscale trace plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">chains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">post_ls</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;gp_ls_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">post_ls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">post_ls</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chains</span><span class="p">)</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;gp_ls_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">reset_defaults</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">post_ls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">post_ls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">post_ls</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Chain &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Draw&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Lengthscale (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="lengthscale_stability">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.lengthscale_stability">[docs]</a>
<span class="k">def</span> <span class="nf">lengthscale_stability</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the posterior standard deviation of the :class:`pymc.gp.cov.ExpQuad &lt;pymc.gp.cov.ExpQuad&gt;` covariance kernel lengthscale when 1 through *N* chains are considered. When the posterior has been sufficiently explored, the standard deviation will stabilize; if it has not stabilized, then additional chains should be run.</span>

<span class="sd">    To consider chains from multiple traces associated with the same inference model, first combine the traces (saved as NetCDF files) using :py:meth:`combine_traces() &lt;stratmc.data&gt;` in :py:mod:`stratmc.data`.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_trace</span>
<span class="sd">        from stratmc.plotting import lengthscale_stability</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace_convergence&#39;)</span>

<span class="sd">        lengthscale_stability(full_trace)</span>

<span class="sd">        plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Target proxy; only required if more than one proxy was included in the inference.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure showing the standard deviation of the covariance kernel lengthscale hyperparameter posterior for 1 through *N* chains.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">gp_ls_variance</span> <span class="o">=</span> <span class="n">calculate_lengthscale_stability</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gp_ls_variance</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gp_ls_variance</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of chains&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Lengthscale standard deviation (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="proxy_signal_stability">
<a class="viewcode-back" href="../../docs/plotting.html#stratmc.plotting.proxy_signal_stability">[docs]</a>
<span class="k">def</span> <span class="nf">proxy_signal_stability</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the sum (over all time slices) of the residuals between the median inferred proxy signal when all *N* chains are considered compared to when 1 to *N-1* chains are considered. When the posterior has been sufficiently explored, the residuals will stabilize and approach zero; if they have not stabilized, then additional chains should be run.</span>

<span class="sd">    To consider chains from multiple traces associated with the same inference model, first combine the traces (saved as NetCDF files) using :py:meth:`combine_traces() &lt;stratmc.data&gt;` in :py:mod:`stratmc.data`.</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from stratmc.config import PROJECT_ROOT</span>
<span class="sd">        from stratmc.data import load_trace</span>
<span class="sd">        from stratmc.plotting import proxy_signal_stability</span>

<span class="sd">        full_trace = load_trace(str(PROJECT_ROOT) + &#39;/examples/example_docs_trace_convergence&#39;)</span>

<span class="sd">        proxy_signal_stability(full_trace, proxy = &#39;d13c&#39;)</span>

<span class="sd">        plt.show()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Target proxy; only required if more than one proxy was included in the inference.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.pyplot.figure</span>
<span class="sd">        Figure showing the stability of the proxy signal inference.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;fontsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">median_residuals</span> <span class="o">=</span> <span class="n">calculate_proxy_signal_stability</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">median_residuals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">median_residuals</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of chains&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sum of median &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; residuals&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>

</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Stacey Edmonsond.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>