
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stratmc.synthetics &#8212; StratMC v1.0 Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/stratmc/synthetics';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Jul 29, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/stratmc.png" class="logo__image only-light" alt="StratMC v1.0 Manual - Home"/>
    <script>document.write(`<img src="../../_static/stratmc.png" class="logo__image only-dark" alt="StratMC v1.0 Manual - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sedmonsond/stratmc" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/StaceyEdmonsond" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sedmonsond/stratmc" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/StaceyEdmonsond" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">stratmc.synthetics</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for stratmc.synthetics</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span><span class="p">,</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">stratmc.model</span> <span class="kn">import</span> <span class="n">build_model</span>


<div class="viewcode-block" id="make_excursion">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.make_excursion">[docs]</a>
<span class="k">def</span> <span class="nf">make_excursion</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">baseline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rising_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rate_offset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">excursion_duration</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_duration</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">smooth</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">smoothing_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for generating a synthetic proxy signal that contains a number of user-specified excursions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    time: numpy.array(float)</span>
<span class="sd">        Time vector over which to generate proxy signal.</span>

<span class="sd">    amplitude: float, list(float), or numpy.array(float)</span>
<span class="sd">        Amplitude of excursion; pass a list or array to generate multiple excursions.</span>

<span class="sd">    baseline: float, optional</span>
<span class="sd">        Baseline proxy value; defaults to 0.</span>

<span class="sd">    rising_time: float, list(float), or numpy.array(float), optional</span>
<span class="sd">        Fraction of excursion duration spent on the rising limb (linear increase/decrease toward peak).</span>
<span class="sd">        Must be between 0 and 1. If not provided, randomly generated if ``rate_offset`` is ``True`` and set to 0.5 if ``rate_offset`` is  ``False``. Pass a list to specify different rising times for each excursion.</span>

<span class="sd">    rate_offset: bool, optional</span>
<span class="sd">        If ``False``, rising and falling limbs of excursion have equal duration. If ``True``, the fraction of the excursion duration spent on the rising limb is set by ``rising_time``. Defaults to ``False``.</span>

<span class="sd">    excursion_duration: float, list(float), or numpy.array(float), optional</span>
<span class="sd">        Duration of excursion; pass a list or array to generate multiple excursions. Random if not provided.</span>

<span class="sd">    min_duration: float, optional</span>
<span class="sd">        Minimum excursion duration if ``excursion_duration`` is not provided. Defaults to 1.</span>

<span class="sd">    smooth: bool, optional</span>
<span class="sd">        Smooth excursion peaks; defaults to ``False``.</span>

<span class="sd">    smoothing_factor: float, optional</span>
<span class="sd">        Smoothing factor if ``smooth`` is ``True``; higher values produce smoother signals. Defaults to 10.</span>

<span class="sd">    seed: int, optional</span>
<span class="sd">        Random seed used to generate signal.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    interp_proxy: np.array</span>
<span class="sd">        Tracer signal interpolated to points in the ``time`` vector</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">amplitude</span><span class="p">))</span>

    <span class="c1"># if excursion duration not in inputs</span>
    <span class="k">if</span> <span class="n">excursion_duration</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">excursion_duration</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
            <span class="n">excursion_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">excursion_duration</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># multiple excursions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">excursion_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">excursion_duration</span><span class="p">])</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
            <span class="n">excursion_duration</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">duration_sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amplitude</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">max_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">duration_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">min_duration</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
                <span class="n">excursion_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">min_duration</span><span class="p">,</span> <span class="n">max_duration</span><span class="p">))</span>
                <span class="n">duration_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)</span>

    <span class="c1"># if excursion duration in inputs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>

    <span class="n">excursion_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">))</span>

    <span class="c1"># fraction of excursion duration spent on rising vs. falling limb of excursion</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rising_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rate_offset</span><span class="p">):</span>
        <span class="n">rising_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">))</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">rising_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rate_offset</span><span class="p">):</span>
        <span class="n">rising_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">rising_frac</span> <span class="o">=</span> <span class="n">rising_time</span>

    <span class="n">rising_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rising_frac</span><span class="p">)</span>

    <span class="c1"># if more than 1 excursion, choose random starting point for each excursion</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># check that total excursion duration does not exceed total timespan</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Sum of excursion durations exceeds total time&#39;</span><span class="p">)</span>

        <span class="n">excursion_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)):</span>
            <span class="n">max_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">current_min</span><span class="p">,</span> <span class="n">max_start</span><span class="p">)</span>
            <span class="n">excursion_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">current_min</span> <span class="o">=</span> <span class="n">excursion_start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">excursion_duration</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># if only 1 excursion, choose random starting point</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">excursion_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">excursion_duration</span><span class="p">)]</span>
        <span class="n">excursion_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">excursion_start</span><span class="p">)</span>

    <span class="c1"># generate proxy signal for each excursion</span>
    <span class="n">excursion_proxy</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">excursion_time</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)),</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">excursion_duration</span><span class="p">,</span> <span class="n">excursion_start</span><span class="p">):</span>
            <span class="n">peak_time</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">rising_frac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dur</span><span class="p">)</span>
            <span class="n">base_time</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">dur</span>

            <span class="c1"># fit line through rising limb</span>
            <span class="n">rising_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">([</span><span class="n">base_time</span><span class="p">,</span> <span class="n">peak_time</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">amp</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">rising_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">base_time</span><span class="p">,</span> <span class="n">peak_time</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">rising_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">rising_p</span><span class="p">,</span> <span class="n">rising_t</span><span class="p">)</span>

            <span class="c1"># fit line through falling limb</span>
            <span class="n">falling_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">([</span><span class="n">peak_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">],</span> <span class="p">[</span><span class="n">amp</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">falling_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">peak_time</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">falling_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">falling_p</span><span class="p">,</span> <span class="n">falling_t</span><span class="p">)</span>

            <span class="c1"># combine rising and falling limbs</span>
            <span class="n">excursion_proxy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rising_proxy</span><span class="p">,</span> <span class="n">falling_proxy</span><span class="p">])</span>
            <span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rising_t</span><span class="p">,</span> <span class="n">falling_t</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
                <span class="n">spline</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">excursion_proxy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="n">smoothing_factor</span><span class="p">)</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">2000</span><span class="p">)</span>
                <span class="n">excursion_proxy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
                <span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_new</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peak_time</span> <span class="o">=</span> <span class="n">excursion_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rising_frac</span> <span class="o">*</span> <span class="n">excursion_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">base_time</span> <span class="o">=</span> <span class="n">excursion_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">excursion_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">excursion_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># fit line through rising limb</span>
        <span class="n">rising_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">([</span><span class="n">base_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peak_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">rising_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">base_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peak_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">rising_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">rising_p</span><span class="p">,</span> <span class="n">rising_t</span><span class="p">)</span>

        <span class="c1"># fit line through falling limb</span>
        <span class="n">falling_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">([</span><span class="n">peak_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">amplitude</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">falling_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">peak_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">end_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">falling_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">falling_p</span><span class="p">,</span> <span class="n">falling_t</span><span class="p">)</span>

        <span class="c1"># combine rising and falling limbs</span>
        <span class="n">excursion_proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rising_proxy</span><span class="p">,</span> <span class="n">falling_proxy</span><span class="p">])</span>
        <span class="n">excursion_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rising_t</span><span class="p">,</span> <span class="n">falling_t</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">excursion_proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="n">smoothing_factor</span><span class="p">)</span>
            <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">excursion_proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
            <span class="n">excursion_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_new</span>


    <span class="c1"># fill with baseline outside of excursions</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">excursion_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">excursion_start</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">timeline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

            <span class="n">proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="n">timeline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">excursion_proxy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">excursion_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">timeline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">excursion_duration</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeline</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">timeline</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">timeline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

    <span class="c1"># interpolate to original time vector</span>
    <span class="n">proxy_fun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
    <span class="n">interp_proxy</span> <span class="o">=</span> <span class="n">proxy_fun</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="n">baseline</span>

    <span class="k">return</span> <span class="n">interp_proxy</span></div>


<div class="viewcode-block" id="synthetic_sections">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.synthetic_sections">[docs]</a>
<span class="k">def</span> <span class="nf">synthetic_sections</span><span class="p">(</span><span class="n">true_time</span><span class="p">,</span> <span class="n">true_proxy</span><span class="p">,</span> <span class="n">num_sections</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">max_section_thickness</span><span class="p">,</span> <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d13c&#39;</span><span class="p">],</span> <span class="n">noise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">noise_amp</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">min_constraints</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_constraints</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for generating synthetic proxy observations and age constraints using a predefined proxy signal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    true_time: numpy.array(float)</span>
<span class="sd">        True time vector for input signal.</span>

<span class="sd">    true_proxy: numpy.array(float)</span>
<span class="sd">        True proxy vector for input signal.</span>

<span class="sd">    num_sections: int</span>
<span class="sd">        Number of synthetic sections to generate.</span>

<span class="sd">    num_samples: int</span>
<span class="sd">        Number of samples per synthetic section.</span>

<span class="sd">    max_section_thickness: float</span>
<span class="sd">        Maximum thickness of synthetic sections.</span>

<span class="sd">    proxies: str or list(str), optional</span>
<span class="sd">        Column name(s) for synthetic proxy observations in ``sample_df``; defaults to &#39;d13c&#39;.</span>

<span class="sd">    noise: bool, optional</span>
<span class="sd">        Whether to add white noise to proxy observations; defaults to ``False``.</span>

<span class="sd">    noise_amp: float, optional</span>
<span class="sd">        Amplitude of white noise added to proxy observations (if ``noise`` is ``True``); defaults to 0.1.</span>

<span class="sd">    min_constraints: int, optional</span>
<span class="sd">        Minimum number of age constraints per synthetic section (must be at least 2); defaults to 2.</span>

<span class="sd">    max_constraints: int, optional</span>
<span class="sd">        Maximum number of age constraints per synthetic section; defaults to 3.</span>

<span class="sd">    seed: int, optional</span>
<span class="sd">        Random seed used to generate synthetic sections.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for synthetic sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for synthetic sections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxies</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">true_proxy</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">true_proxy</span>
        <span class="n">true_proxy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">true_proxy</span><span class="p">[</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="n">section_ages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">proxy_vec</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="n">proxy_vec</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">heights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">age_heights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">age_std</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">age_section_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">section_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_sections</span><span class="p">):</span>
        <span class="n">proxy_temp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">section</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;age_constraints&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># ages</span>
            <span class="n">ages_dict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;age_constraints&#39;</span><span class="p">]</span>
            <span class="n">ages_std_dict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;age_constraints_std&#39;</span><span class="p">]</span>
            <span class="n">section_ages_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ages_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ages_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]),</span> <span class="n">num_samples</span><span class="p">)))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># sample ages</span>
            <span class="n">section_ages_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">true_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">true_time</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">)))</span>

            <span class="c1"># true_time must be strictly increasing for valid interpolation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">true_time</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
                <span class="n">true_proxy</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_proxy</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">true_time</span><span class="p">)]</span>
            <span class="n">true_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">true_time</span><span class="p">)</span>

        <span class="c1"># sample proxy</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">section_ages_temp</span><span class="p">,</span> <span class="n">true_time</span><span class="p">,</span> <span class="n">true_proxy</span><span class="p">[</span><span class="n">proxy</span><span class="p">])</span>


        <span class="c1"># sample heights</span>
        <span class="n">heights_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_section_thickness</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">max_section_thickness</span><span class="p">,</span> <span class="mi">100000</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">)</span>

        <span class="n">heights_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">heights_temp</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;age_constraints&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ages_temp</span> <span class="o">=</span> <span class="n">ages_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ages_temp</span><span class="p">)</span>
            <span class="n">ages_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">ages_temp</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">])</span>
            <span class="n">age_std_temp</span> <span class="o">=</span> <span class="n">ages_std_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
            <span class="n">age_std_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">age_std_temp</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">])</span>

            <span class="n">age_heights_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">ages_temp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">section_ages_temp</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">heights_temp</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">age_heights_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">heights_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">age_heights_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">age_heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">age_heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># number of age constraints</span>
            <span class="n">num_ages</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">min_constraints</span><span class="p">,</span><span class="n">max_constraints</span><span class="p">)</span><span class="c1">#random.randrange(2,3)</span>

            <span class="c1"># height of age constraints</span>
            <span class="n">age_heights_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">heights_temp</span><span class="p">),</span> <span class="mi">100000</span><span class="p">),</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">num_ages</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">age_heights_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">heights_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">age_heights_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_heights_temp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">num_ages</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">age_heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">age_heights_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_heights_temp</span><span class="p">,</span> <span class="n">heights_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">num_ages</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">age_heights_temp</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c1"># age of constraints</span>
            <span class="n">ages_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">age_heights_temp</span><span class="p">,</span> <span class="n">heights_temp</span><span class="p">,</span> <span class="n">section_ages_temp</span><span class="p">)</span>

            <span class="c1"># age uncertainties</span>
            <span class="n">age_std_temp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">num_ages</span><span class="p">))</span>


        <span class="n">age_section_names_temp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">age_heights_temp</span><span class="p">)</span>
        <span class="n">section_names_temp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">heights_temp</span><span class="p">)</span>

        <span class="n">section_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section_ages</span><span class="p">,</span> <span class="n">section_ages_temp</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">noise</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">noise_amp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">noise_amp</span>
                <span class="n">noise_amp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
                    <span class="n">noise_amp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_sections</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp</span>

            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">noise_amp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">noise_amp</span><span class="p">[</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">noise_amp</span><span class="p">[</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_amp</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span>
                        <span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_amp</span><span class="p">[</span><span class="n">proxy</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]))</span>
                        <span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>

        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="n">proxy_vec</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy_vec</span><span class="p">[</span><span class="n">proxy</span><span class="p">],</span> <span class="n">proxy_temp</span><span class="p">[</span><span class="n">proxy</span><span class="p">])</span>

        <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heights</span><span class="p">,</span> <span class="n">heights_temp</span><span class="p">)</span>

        <span class="n">ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">ages_temp</span><span class="p">)</span>
        <span class="n">age_heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_heights</span><span class="p">,</span> <span class="n">age_heights_temp</span><span class="p">)</span>
        <span class="n">age_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_std</span><span class="p">,</span> <span class="n">age_std_temp</span><span class="p">)</span>

        <span class="n">age_section_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_section_names</span><span class="p">,</span> <span class="n">age_section_names_temp</span><span class="p">)</span>
        <span class="n">section_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section_names</span><span class="p">,</span> <span class="n">section_names_temp</span><span class="p">)</span>


    <span class="n">ages_df</span><span class="p">,</span> <span class="n">sample_df</span> <span class="o">=</span> <span class="n">synthetic_signal_to_df</span><span class="p">(</span><span class="n">proxy_vec</span><span class="p">,</span>
                                                <span class="n">heights</span><span class="p">,</span>
                                                <span class="n">section_ages</span><span class="p">,</span>
                                                <span class="n">section_names</span><span class="p">,</span>
                                                <span class="n">ages</span><span class="p">,</span> <span class="n">age_std</span><span class="p">,</span>
                                                <span class="n">age_heights</span><span class="p">,</span>
                                                <span class="n">age_section_names</span><span class="p">,</span>
                                                <span class="n">proxies</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sample_df</span></div>


<div class="viewcode-block" id="synthetic_signal_to_df">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.synthetic_signal_to_df">[docs]</a>
<span class="k">def</span> <span class="nf">synthetic_signal_to_df</span><span class="p">(</span><span class="n">proxy_vec</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">section_ages</span><span class="p">,</span> <span class="n">section_names</span><span class="p">,</span> <span class="n">ages</span><span class="p">,</span> <span class="n">age_std</span><span class="p">,</span> <span class="n">age_heights</span><span class="p">,</span> <span class="n">age_section_names</span><span class="p">,</span> <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d13c&#39;</span><span class="p">]):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for generating artificial sample and age data using :py:meth:`synthetic_sections() &lt;stratmc.synthetics&gt;`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    proxy_vec: np.array of float</span>
<span class="sd">        Array of proxy observations. Pass as a dictionary if more than one proxy.</span>

<span class="sd">    heights: np.array of float</span>
<span class="sd">        Array of heights corresponding to proxy observations in ``proxy_vec``.</span>

<span class="sd">    section_ages: np.array of float</span>
<span class="sd">        Array of ages corresponding to proxy observations in ``proxy_vec``.</span>

<span class="sd">    section_names: np.array of str</span>
<span class="sd">        Array of section names corresponding to proxy observations in ``proxy_vec``.</span>

<span class="sd">    ages: np.array of float</span>
<span class="sd">        Array of age constraints.</span>

<span class="sd">    age_std: np.array of float</span>
<span class="sd">        Array of uncertainties for each age constraint in ``ages``.</span>

<span class="sd">    age_heights: np.array of float</span>
<span class="sd">        Array of heights for each age constraint in ``ages``.</span>

<span class="sd">    age_section_names: np.array of str</span>
<span class="sd">        Array of section names corresponding to age constraints in ``ages``.</span>

<span class="sd">    proxies: str or list(str), optional</span>
<span class="sd">        Name(s) of proxies; defaults to `d13c`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for synthetic sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for synthetic sections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxies</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">proxy_vec</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">proxy_vec</span>
        <span class="n">proxy_vec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">proxy_vec</span><span class="p">[</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="c1"># ages dataframe:</span>
    <span class="n">ages_df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;section&#39;</span><span class="p">:</span> <span class="n">age_section_names</span><span class="p">,</span>
               <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">age_heights</span><span class="p">,</span>
              <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">ages</span><span class="p">,</span>
              <span class="s1">&#39;age_std&#39;</span><span class="p">:</span> <span class="n">age_std</span><span class="p">}</span>

    <span class="n">ages_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">)</span>

    <span class="n">ages_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># sample dataframe:</span>
    <span class="n">sample_df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;section&#39;</span><span class="p">:</span> <span class="n">section_names</span><span class="p">,</span>
                 <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">heights</span><span class="p">,</span>
                 <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">section_ages</span><span class="p">,</span>
                 <span class="p">}</span>

    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_vec</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span>

    <span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">)</span>

    <span class="n">sample_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;distribution_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Normal&#39;</span>

    <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sample_df</span></div>


<div class="viewcode-block" id="synthetic_observations_from_prior">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.synthetic_observations_from_prior">[docs]</a>
<span class="k">def</span> <span class="nf">synthetic_observations_from_prior</span><span class="p">(</span><span class="n">age_vector</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sample_heights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">uniform_heights</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">samples_per_section</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d13c&#39;</span><span class="p">],</span> <span class="n">proxy_std</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ls_dist</span> <span class="o">=</span> <span class="s1">&#39;Wald&#39;</span><span class="p">,</span> <span class="n">ls_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ls_mu</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">ls_lambda</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">ls_sigma</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">var_sigma</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">white_noise_sigma</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="p">,</span>  <span class="n">gp_mean_mu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gp_mean_sigma</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">approximate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hsgp_m</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">hsgp_c</span> <span class="o">=</span> <span class="mf">1.3</span><span class="p">,</span> <span class="n">offset_type</span> <span class="o">=</span> <span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="n">offset_prior</span> <span class="o">=</span> <span class="s1">&#39;Laplace&#39;</span><span class="p">,</span> <span class="n">offset_alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset_beta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset_sigma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset_mu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset_b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">noise_type</span> <span class="o">=</span> <span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="n">noise_prior</span> <span class="o">=</span> <span class="s1">&#39;HalfCauchy&#39;</span><span class="p">,</span> <span class="n">noise_beta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">noise_sigma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">noise_nu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jitter</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given age constraints for a set of stratigraphic sections in ``ages_df``, generate synthetic proxy observations by sampling the model prior. Accepts all arguments that can be passed to :py:meth:`build_model() &lt;stratmc.model.build_model&gt;` in :py:mod:`stratmc.model`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    age_vector: np.array(float)</span>
<span class="sd">        Vector of ages at which to evaluate synthetic proxy signal(s).</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for synthetic sections.</span>

<span class="sd">    sample_heights: dict{list(float) or numpy.array(float)}, optional</span>
<span class="sd">        Sample heights for each stratigraphic section in ``ages_df``; must be a dictionary with section names as keys. Defaults to ``None``, which results in either uniformly spaced or randomly spaced sample heights (depending on the ``uniform_heights`` argument).</span>

<span class="sd">    uniform_heights: bool, optional</span>
<span class="sd">        Whether to generate uniformly spaced (set to ``True``) or randomly spaced (set to ``False``) sample heights if dictionary of ``sample_heights`` not provided; defaults to ``False`` (randomly spaced samples).</span>

<span class="sd">    samples_per_section: int or dict(int), optional</span>
<span class="sd">        Number of samples per section to generate if ``sample_heights`` not provided; either an integer (if the same for all sections) or a dictionary with section names as keys. Defaults to 20.</span>

<span class="sd">    proxies: list(str), optional</span>
<span class="sd">        List of proxies to generate synthetic observations for; defaults to `d13c`.</span>

<span class="sd">    proxy_std: float or dict(float), optional</span>
<span class="sd">        Measurement uncertainty for each proxy; pass a dictionary of floats with the elements of ``proxies`` as keys to use a different value for each proxy, or an integer to use the same value for all proxies. Defaults to 0.1.</span>

<span class="sd">    seed: int, optional</span>
<span class="sd">        Seed to use while generating synthetic observations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    signals: dict(float)</span>
<span class="sd">        Tracers signals drawn from the model prior (evaluated at the points in ``age_vector``) used to generate synthetic observations; dictionary keys are ``proxies``.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for synthetic stratigraphic sections.</span>

<span class="sd">    prior: arviz.InferenceData</span>
<span class="sd">        An  :class:`arviz.InferenceData` object containing the prior draw from the model used to generate synthetic observations.</span>

<span class="sd">    model: pymc.Model</span>
<span class="sd">        :class:`pymc.model.core.Model` object used to generate synthetic observations.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]))</span>


    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">proxy_std</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">proxy_std</span>
        <span class="n">proxy_std</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">proxy_std</span><span class="p">[</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">std</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">proxy_std</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">proxy_std</span>
        <span class="n">proxy_std</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="n">proxy_std</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span>

    <span class="c1"># if sample heights are not provided, then generate synthetic &#39;sample heights&#39; with np.random.uniform in between the minimum and maximum age heights</span>
    <span class="k">if</span> <span class="n">sample_heights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">samples_per_section</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">samples_per_section</span>
            <span class="n">samples_per_section</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
                <span class="n">samples_per_section</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="n">sample_heights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">min_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">max_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">uniform_heights</span><span class="p">:</span>
                <span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">samples_per_section</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">min_height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">max_height</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">samples_per_section</span><span class="p">[</span><span class="n">section</span><span class="p">]))</span>

    <span class="c1"># if sample heights not provided and samples per section not specified</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">sample_heights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sample_heights must be a dictionary (keys = section names, values = array or list of sample heights)&quot;</span><span class="p">)</span>

    <span class="n">sample_df_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">proxy</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">]</span>
    <span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">sample_df_columns</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">section_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;section&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">]),</span>
        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">],</span>
        <span class="s1">&#39;Exclude?&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="n">section_dict</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
            <span class="n">section_dict</span><span class="p">[</span><span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_heights</span><span class="p">[</span><span class="n">section</span><span class="p">]))</span> <span class="o">*</span> <span class="n">proxy_std</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span>

        <span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">section_dict</span><span class="p">)],</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># make sure ages_df has all of the required columns</span>
    <span class="n">ages_df_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distribution_type&#39;</span><span class="p">,</span> <span class="s1">&#39;param_1&#39;</span><span class="p">,</span> <span class="s1">&#39;param_2&#39;</span><span class="p">,</span> <span class="s1">&#39;param_1_name&#39;</span><span class="p">,</span> <span class="s1">&#39;param_2_name&#39;</span><span class="p">,</span> <span class="s1">&#39;shared?&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Exclude?&#39;</span><span class="p">,</span> <span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">,</span> <span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ages_df_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ages_df</span><span class="p">):</span>
            <span class="n">ages_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;distribution_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Normal&#39;</span>

    <span class="n">sample_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

   <span class="c1"># build a model using the synthetic data (set proxy_observed = False in build_model)</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span>
                            <span class="n">ages_df</span><span class="p">,</span>
                            <span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span>
                            <span class="n">proxies</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span>
                            <span class="n">proxy_sigma_default</span> <span class="o">=</span> <span class="n">proxy_std</span><span class="p">,</span>
                            <span class="n">ls_dist</span> <span class="o">=</span> <span class="n">ls_dist</span><span class="p">,</span>
                            <span class="n">ls_min</span> <span class="o">=</span> <span class="n">ls_min</span><span class="p">,</span>
                            <span class="n">ls_mu</span> <span class="o">=</span> <span class="n">ls_mu</span><span class="p">,</span>
                            <span class="n">ls_lambda</span> <span class="o">=</span> <span class="n">ls_lambda</span><span class="p">,</span>
                            <span class="n">ls_sigma</span> <span class="o">=</span> <span class="n">ls_sigma</span><span class="p">,</span>
                            <span class="n">var_sigma</span> <span class="o">=</span> <span class="n">var_sigma</span><span class="p">,</span>
                            <span class="n">white_noise_sigma</span> <span class="o">=</span> <span class="n">white_noise_sigma</span><span class="p">,</span>
                            <span class="n">gp_mean_mu</span> <span class="o">=</span> <span class="n">gp_mean_mu</span><span class="p">,</span>
                            <span class="n">gp_mean_sigma</span> <span class="o">=</span> <span class="n">gp_mean_sigma</span><span class="p">,</span>
                            <span class="n">approximate</span> <span class="o">=</span> <span class="n">approximate</span><span class="p">,</span>
                            <span class="n">offset_type</span> <span class="o">=</span> <span class="n">offset_type</span><span class="p">,</span>
                            <span class="n">offset_prior</span> <span class="o">=</span> <span class="n">offset_prior</span><span class="p">,</span>
                            <span class="n">offset_alpha</span> <span class="o">=</span> <span class="n">offset_alpha</span><span class="p">,</span>
                            <span class="n">offset_beta</span> <span class="o">=</span> <span class="n">offset_beta</span><span class="p">,</span>
                            <span class="n">offset_sigma</span> <span class="o">=</span> <span class="n">offset_sigma</span><span class="p">,</span>
                            <span class="n">offset_mu</span> <span class="o">=</span> <span class="n">offset_mu</span><span class="p">,</span>
                            <span class="n">offset_b</span> <span class="o">=</span> <span class="n">offset_b</span><span class="p">,</span>
                            <span class="n">noise_type</span> <span class="o">=</span> <span class="n">noise_type</span><span class="p">,</span>
                            <span class="n">noise_prior</span> <span class="o">=</span> <span class="n">noise_prior</span><span class="p">,</span>
                            <span class="n">noise_beta</span> <span class="o">=</span> <span class="n">noise_beta</span><span class="p">,</span>
                            <span class="n">noise_sigma</span> <span class="o">=</span> <span class="n">noise_sigma</span><span class="p">,</span>
                            <span class="n">noise_nu</span> <span class="o">=</span> <span class="n">noise_nu</span><span class="p">,</span>
                            <span class="n">hsgp_m</span> <span class="o">=</span> <span class="n">hsgp_m</span><span class="p">,</span>
                            <span class="n">hsgp_c</span> <span class="o">=</span> <span class="n">hsgp_c</span><span class="p">,</span>
                            <span class="n">jitter</span> <span class="o">=</span> <span class="n">jitter</span><span class="p">,</span>
                            <span class="n">proxy_observed</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="p">)</span>

    <span class="k">with</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># single draw from the prior</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="n">f_pred</span> <span class="o">=</span> <span class="n">gp</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">Xnew</span> <span class="o">=</span> <span class="n">age_vector</span><span class="p">,</span> <span class="n">jitter</span> <span class="o">=</span> <span class="n">jitter</span><span class="p">)</span>

        <span class="n">prior</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_prior_predictive</span><span class="p">(</span><span class="n">samples</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>

    <span class="n">signals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">sample_df</span><span class="p">[</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="n">proxy</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="n">section</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">signals</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="n">model</span></div>



<div class="viewcode-block" id="synthetic_signal_from_prior">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.synthetic_signal_from_prior">[docs]</a>
<span class="k">def</span> <span class="nf">synthetic_signal_from_prior</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">num_signals</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ls_dist</span> <span class="o">=</span> <span class="s1">&#39;Wald&#39;</span><span class="p">,</span> <span class="n">ls_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ls_mu</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">ls_lambda</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">ls_sigma</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">var_sigma</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">gp_mean_mu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gp_mean_sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draws synthetic signals from the model prior, and returns the signal conditioned over the points in ``ages``. To generate both signals and synthetic stratigraphic sections, instead use :py:meth:`synthetic_observations_from_prior() &lt;stratmc.synthetics&gt;`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ages: numpy.array(float)</span>
<span class="sd">        Array of ages over which to condition the signal.</span>

<span class="sd">    num_signals: int, optional</span>
<span class="sd">        Number of signals to draw from prior; defaults to 100.</span>

<span class="sd">    ls_dist: str, optional</span>
<span class="sd">        Prior distribution for the lengthscale hyperparameter of the exponential quadratic covariance kernel (:class:`pymc.gp.cov.ExpQuad &lt;pymc.gp.cov.ExpQuad&gt;`); set to ``Wald`` (:class:`pymc.Wald`) or ``HalfNormal`` (:class:`pymc.HalfNormal`). Defaults to ``Wald`` with ``mu = 20`` and ``lambda = 50``; to change ``mu`` and ``lambda``, pass the ``ls_mu`` and ``ls_lambda`` parameters. For ``HalfNormal``, the variance defaults to ``sigma = 50``; change by passing ``ls_sigma``.</span>

<span class="sd">    ls_min: float, optional</span>
<span class="sd">        Minimum value for the lengthscale hyperparameter of the :class:`pymc.gp.cov.ExpQuad` covariance kernel; shifts the lengthscale prior by ``ls_min``. Defaults to 0.</span>

<span class="sd">    ls_mu: float, optional</span>
<span class="sd">        Mean (`mu`) of the :class:`pymc.gp.cov.ExpQuad` lengthscale prior if ``ls_dist = `Wald```; defaults to 20.</span>

<span class="sd">    ls_lambda: float, optional</span>
<span class="sd">        Relative precision (`lam`) of the :class:`pymc.gp.cov.ExpQuad` lengthscale hyperparameter prior if ``ls_dist = `Wald```; defaults to 50.</span>

<span class="sd">    ls_sigma: float, optional</span>
<span class="sd">        Scale parameter (`sigma`) of the :class:`pymc.gp.cov.ExpQuad` lengthscale hyperparameter prior if ``ls_dist = `HalfNormal```; defaults to 50.</span>

<span class="sd">    var_sigma: float, optional</span>
<span class="sd">        Scale parameter (`sigma&#39;) of the covariance kernel variance hyperparameter prior, which is a :class:`pymc.HalfNormal` distribution; defaults to 10.</span>

<span class="sd">    gp_mean_mu: float, optional</span>
<span class="sd">        Mean (`mu`) of the GP mean function prior, which is a :class:`pymc.Normal` distribution; defaults to 0.</span>

<span class="sd">    gp_mean_sigma: float, optional</span>
<span class="sd">        Standard deviation (`sigma`) of the GP mean function prior, which is a :class:`pymc.Normal` distribution; defaults to 5.</span>

<span class="sd">    seed: int, optional</span>
<span class="sd">        Random seed used to generate signals.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    signal: numpy.ndarray(float)</span>
<span class="sd">        Array with shape ``ages x number of signals`` containing the ``n = num_signals`` synthetic signals drawn from the prior.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># proxy GP</span>
        <span class="k">if</span> <span class="n">ls_dist</span> <span class="o">==</span> <span class="s1">&#39;Wald&#39;</span><span class="p">:</span>
            <span class="n">gp_ls_unshifted</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Wald</span><span class="p">(</span><span class="s1">&#39;gp_ls_unshifted&#39;</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">ls_mu</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="n">ls_lambda</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">ls_dist</span> <span class="o">==</span> <span class="s1">&#39;HalfNormal&#39;</span><span class="p">:</span>
            <span class="n">gp_ls_unshifted</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;gp_ls_unshifted&#39;</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">ls_sigma</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">gp_ls</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;gp_ls&#39;</span><span class="p">,</span> <span class="n">gp_ls_unshifted</span> <span class="o">+</span> <span class="n">ls_min</span><span class="p">)</span>

        <span class="n">gp_var</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;gp_var&#39;</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">var_sigma</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">m_proxy</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">gp_mean_mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">gp_mean_sigma</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># mean and covariance functions</span>
        <span class="n">mean_fun</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">m_proxy</span><span class="p">)</span>
        <span class="n">cov1</span> <span class="o">=</span> <span class="n">gp_var</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gp_ls</span><span class="p">)</span>

        <span class="c1"># GP prior</span>
        <span class="n">gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Latent</span><span class="p">(</span><span class="n">mean_func</span> <span class="o">=</span> <span class="n">mean_fun</span><span class="p">,</span> <span class="n">cov_func</span> <span class="o">=</span> <span class="n">cov1</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">ages</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                         <span class="n">reparameterize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">prior</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_prior_predictive</span><span class="p">(</span><span class="n">samples</span> <span class="o">=</span> <span class="n">num_signals</span><span class="p">,</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>

    <span class="n">signals</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">signals</span><span class="p">,</span> <span class="n">prior</span></div>



<div class="viewcode-block" id="quantify_signal_recovery">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.quantify_signal_recovery">[docs]</a>
<span class="k">def</span> <span class="nf">quantify_signal_recovery</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">true_signal</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="s1">&#39;d13c&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;posterior&#39;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the likelihood of the true signal (for synthetic tests, where the true signal is known) given draws from the posterior (default) or prior. The likelihood is evaluated at each age (the posterior signal and the true signal must be evaluated at the same ages). Provides a measure of signal recovery.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData or list(arviz.InferenceData)</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`. If passed as a list, the posterior draws for all traces will be combined when calculating `posterior_likelihood`.</span>

<span class="sd">    true_signal: np.array</span>
<span class="sd">        True values for the proxy signal, evaluated at the same ages as the posterior signal in ``full_trace``.</span>

<span class="sd">    proxy: str, optional</span>
<span class="sd">        Tracer signal to evaluate; defaults to `d13c&#39;.</span>

<span class="sd">    mode: str, optional</span>
<span class="sd">        Whether to use the posterior or prior to calculate signal recovery; defaults to `posterior`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    posterior_likelihood: np.array</span>
<span class="sd">        Array of posterior likelihoods (evaluated at each age).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;posterior&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">post_proxy</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">post_proxy_temp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">post_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">post_proxy</span><span class="p">,</span> <span class="n">post_proxy_temp</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_proxy</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;prior&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">post_proxy</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">post_proxy_temp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">post_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">post_proxy</span><span class="p">,</span> <span class="n">post_proxy_temp</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_proxy</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="s1">&#39;f_pred_&#39;</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_signal</span><span class="p">)</span> <span class="o">!=</span> <span class="n">post_proxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length of true_signal does not match length of posterior predictive signal. Check that both are evaluated at the same ages (if not, interpolate true_signal to the ages at which the posterior signal was evaluated).&quot;</span><span class="p">)</span>

    <span class="n">posterior_likelihood</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">post_proxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">post_proxy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">posterior_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">true_signal</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterior_likelihood</span><span class="p">)</span></div>


<div class="viewcode-block" id="sample_age_recovery">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.sample_age_recovery">[docs]</a>
<span class="k">def</span> <span class="nf">sample_age_recovery</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;posterior&#39;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the likelihood of the true sample ages (for synthetic tests, where the true age of each sample is known) given draws from the posterior (default) or prior. Provides a measure of age model recovery.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData or list(arviz.InferenceData)</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`. If passed as a list, the posterior draws for all traces will be combined when calculating `posterior_likelihood`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for synthetic sections.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections to evaluate; defaults to all sections in sample_df.</span>

<span class="sd">    mode: str, optional</span>
<span class="sd">         Whether to use the posterior or prior age models; defaults to `posterior`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    posterior_likelihood: dict{float} or np.array(float)</span>
<span class="sd">        Posterior likelihoods for the true age of each sample. Returned as an array if only one section is evaluated, or a dictionary of arrays if multiple sections are evaluated.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">posterior_likelihood</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">]</span>
        <span class="n">section_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">true_ages</span> <span class="o">=</span> <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;posterior&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">post_ages_temp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">post_ages</span><span class="p">,</span> <span class="n">post_ages_temp</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;prior&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">post_ages_temp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">post_ages</span><span class="p">,</span> <span class="n">post_ages_temp</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_ages</span><span class="p">)</span> <span class="o">!=</span> <span class="n">post_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of samples in sample_df does not match the number in the trace&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">posterior_likelihood</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">posterior_likelihood</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">post_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">post_ages</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">posterior_likelihood</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">true_ages</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">posterior_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">true_ages</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>


    <span class="k">return</span> <span class="n">posterior_likelihood</span></div>



<div class="viewcode-block" id="sample_age_residuals">
<a class="viewcode-back" href="../../docs/synthetics.html#stratmc.synthetics.sample_age_residuals">[docs]</a>
<span class="k">def</span> <span class="nf">sample_age_residuals</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;posterior&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the residual (for each draw) between the true age and the posterior (default) or prior age of each sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData or list(arviz.InferenceData)</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`. If passed as a list, the posterior draws for all traces will be combined when calculating `age_residuals`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for synthetic sections.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections to evaluate; defaults to all sections in sample_df.</span>

<span class="sd">    mode: str, optional</span>
<span class="sd">         Whether to use the posterior or prior age models; defaults to `posterior`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    age_residuals: np.array</span>
<span class="sd">        Sample age residuals; shape is (number of samples, number of posterior draws). Returned as an array if only one section is evaluated, or a dictionary of arrays if multiple sections are evaluated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">age_residuals</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">true_ages</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section</span><span class="p">][</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;posterior&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">post_ages_temp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">post_ages</span><span class="p">,</span> <span class="n">post_ages_temp</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;prior&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_trace</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">post_ages_temp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">post_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">post_ages</span><span class="p">,</span> <span class="n">post_ages_temp</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_ages</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">prior</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">true_ages_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">true_ages</span><span class="p">,</span> <span class="n">post_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">post_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">age_residuals</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_ages_array</span> <span class="o">-</span> <span class="n">post_ages</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">age_residuals</span> <span class="o">=</span>  <span class="n">true_ages_array</span> <span class="o">-</span> <span class="n">post_ages</span>

    <span class="k">return</span> <span class="n">age_residuals</span></div>

</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Stacey Edmonsond.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>