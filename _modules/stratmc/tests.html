
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stratmc.tests &#8212; StratMC v1.0 Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/stratmc/tests';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Jul 29, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/stratmc.png" class="logo__image only-light" alt="StratMC v1.0 Manual - Home"/>
    <script>document.write(`<img src="../../_static/stratmc.png" class="logo__image only-dark" alt="StratMC v1.0 Manual - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sedmonsond/stratmc" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/StaceyEdmonsond" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sedmonsond/stratmc" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/StaceyEdmonsond" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">stratmc.tests</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for stratmc.tests</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">stratmc.data</span> <span class="kn">import</span> <span class="n">clean_data</span>


<div class="viewcode-block" id="check_inference">
<a class="viewcode-back" href="../../docs/tests.html#stratmc.tests.check_inference">[docs]</a>
<span class="k">def</span> <span class="nf">check_inference</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Master function (calls each of the functions in the ``tests`` module) for checking that superposition is never violated in the posterior. Returns a list of chain indices where superposition was violated; these chains can be dropped from the trace using :py:meth:`drop_chains() &lt;stratmc.data.drop_chains&gt;`. Run automatically inside of :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    Because of the likelihood gradient used to manually enforce detrital and intrusive ages in :py:meth:`intermediate_detrital_potential() &lt;stratmc.model.intermediate_detrital_potential&gt;` and :py:meth:`intermediate_intrusive_potential() &lt;stratmc.model.intermediate_intrusive_potential&gt;` (called in :py:meth:`build_model() &lt;stratmc.model.build_model&gt;`), rare chains may have minor superposition violations when deterital/intrusive ages are present. These chains can simply be discarded. If superposition is frequently violated in a given section, or if superposition violations are severe, check that the heights for all age constraints in ``ages_df`` are correct, and that the reported ages respect superposition. The model can correct for mean ages that are out of superposition, but may fail if the age constraints do not overlap given their 2$\sigma$ uncertainties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections included in the inference. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    quiet: bool, optional</span>
<span class="sd">        Whether to print the type, section name, and chain/draw of each superposition violation; defaults to ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bad_chains: numpy.array</span>
<span class="sd">        Array of chain indices where superposition was violated in the posterior.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">bad_chains_1</span> <span class="o">=</span> <span class="n">check_superposition</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span><span class="p">)</span>
    <span class="n">bad_chains_2</span> <span class="o">=</span> <span class="n">check_detrital_ages</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span><span class="p">)</span>
    <span class="n">bad_chains_3</span> <span class="o">=</span> <span class="n">check_intrusive_ages</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span><span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span><span class="p">)</span>

    <span class="n">bad_chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">bad_chains_1</span><span class="p">,</span> <span class="n">bad_chains_2</span><span class="p">,</span> <span class="n">bad_chains_3</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bad_chains</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_superposition">
<a class="viewcode-back" href="../../docs/tests.html#stratmc.tests.check_superposition">[docs]</a>
<span class="k">def</span> <span class="nf">check_superposition</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that stratigraphic superposition between all age constriants and samples is respected in the posterior.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections included in the inference. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    quiet: bool, optional</span>
<span class="sd">        Whether to print the section name and chain/draw of each superposition violation; defaults to ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bad_chains: numpy.array</span>
<span class="sd">        Array of chain indices where superposition was violated in the posterior.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">ages_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])]</span>

    <span class="n">chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">bad_chains</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">sample_heights</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
        <span class="n">age_heights</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>

        <span class="n">comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sample_heights</span><span class="p">,</span> <span class="n">age_heights</span><span class="p">])</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span>

        <span class="c1"># chains x draws x # samples</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
            <span class="n">sample_posterior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># chains x draws x # ages</span>
            <span class="n">age_posterior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_radiometric_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">posterior_stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">sample_posterior</span><span class="p">,</span> <span class="n">age_posterior</span><span class="p">])</span>

            <span class="n">draws</span> <span class="o">=</span> <span class="n">posterior_stacked</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">draws</span><span class="p">):</span>
                <span class="c1">#assert(all(np.diff(posterior_stacked[sort_idx,i].ravel()) &lt;= 0)), &quot;stratigraphic superposition violated in section &quot; + str(section) + &quot; draw &quot; + str(i)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">posterior_stacked</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stratigraphic superposition violated in section &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, chain &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="o">+</span>  <span class="s2">&quot;, draw &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. Check that the heights for all age constraints in ``ages_df`` are correct, and that the reported ages respect superposition (the model can correct for mean ages that are out of superposition, but may fail if the age constraints do not overlap given their reported uncertainties).&#39;</span><span class="p">)</span>
                    <span class="n">bad_chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">bad_chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bad_chains</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bad_chains</span></div>



<div class="viewcode-block" id="check_detrital_ages">
<a class="viewcode-back" href="../../docs/tests.html#stratmc.tests.check_detrital_ages">[docs]</a>
<span class="k">def</span> <span class="nf">check_detrital_ages</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that detrital age constraints have been enforced in the posterior.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections included in the inference. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    quiet: bool, optional</span>
<span class="sd">        Whether to print the section name and chain/draw of each superposition violation; defaults to ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bad_chains: numpy.array</span>
<span class="sd">        Array of chain indices where superposition was violated in the posterior.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>


    <span class="n">chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">bad_chains</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[(</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])]</span>
        <span class="n">section_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">section_age_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])]</span>
        <span class="n">intermediate_detrital_section_ages_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])]</span>

        <span class="n">age_heights</span> <span class="o">=</span> <span class="n">section_age_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">post_section_ages</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">section</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
            <span class="n">section_sample_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">post_section_ages</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">age_heights</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>

                <span class="n">above</span> <span class="o">=</span> <span class="n">intermediate_detrital_section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">age_heights</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>
                <span class="n">below</span> <span class="o">=</span> <span class="n">intermediate_detrital_section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">age_heights</span><span class="p">[</span><span class="n">interval</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">detrital_interval_df</span> <span class="o">=</span> <span class="n">intermediate_detrital_section_ages_df</span><span class="p">[</span><span class="n">above</span> <span class="o">&amp;</span> <span class="n">below</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">height</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">detrital_interval_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">detrital_interval_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">],</span> <span class="n">detrital_interval_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">detrital_interval_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">height</span>

                    <span class="c1"># check that all the posterior ages for overlying samples are younger than the detrital age during each draw</span>
                    <span class="k">if</span> <span class="n">shared</span><span class="p">:</span>
                        <span class="n">detrital_age_posterior</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;detrital_age_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">detrital_age_posterior</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">dist_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:]</span>


                    <span class="k">for</span> <span class="n">draw</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">section_sample_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1">#assert all(section_sample_ages[:, draw][sample_idx] &lt;= detrital_age_posterior[draw])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">section_sample_ages</span><span class="p">[:,</span> <span class="n">draw</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">detrital_age_posterior</span><span class="p">[</span><span class="n">draw</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Detrital age constraint violated in section &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, chain &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="o">+</span>  <span class="s2">&quot;, draw &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">draw</span><span class="p">))</span>
                            <span class="n">bad_chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">bad_chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bad_chains</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bad_chains</span></div>


<div class="viewcode-block" id="check_intrusive_ages">
<a class="viewcode-back" href="../../docs/tests.html#stratmc.tests.check_intrusive_ages">[docs]</a>
<span class="k">def</span> <span class="nf">check_intrusive_ages</span><span class="p">(</span><span class="n">full_trace</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that intrusive age constraints have been enforced in the posterior.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    full_trace: arviz.InferenceData</span>
<span class="sd">        An :class:`arviz.InferenceData` object containing the full set of prior and posterior samples from :py:meth:`get_trace() &lt;stratmc.inference.get_trace&gt;` in :py:mod:`stratmc.inference`.</span>

<span class="sd">    sample_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing proxy data for all sections.</span>

<span class="sd">    ages_df: pandas.DataFrame</span>
<span class="sd">        :class:`pandas.DataFrame` containing age constraints for all sections.</span>

<span class="sd">    sections: list(str) or numpy.array(str), optional</span>
<span class="sd">        List of sections included in the inference. Defaults to all sections in ``sample_df``.</span>

<span class="sd">    quiet: bool, optional</span>
<span class="sd">        Whether to print the section name and chain/draw of each superposition violation; defaults to ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bad_chains: numpy.array</span>
<span class="sd">        Array of chain indices where superposition was violated in the posterior.</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># get list of proxies included in model from full_trace</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;gp_ls_&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;unshifted&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="s1">&#39;sections&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sections&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="s1">&#39;section&#39;</span><span class="p">])</span>

    <span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">ages_df</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>

    <span class="n">chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">bad_chains</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">section_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">]</span>
        <span class="n">section_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">section_age_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate detrital?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;Exclude?&#39;</span><span class="p">])]</span>
        <span class="n">intermediate_intrusive_section_ages_df</span> <span class="o">=</span> <span class="n">ages_df</span><span class="p">[(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">section</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ages_df</span><span class="p">[</span><span class="s1">&#39;intermediate intrusive?&#39;</span><span class="p">])]</span>

        <span class="n">age_heights</span> <span class="o">=</span> <span class="n">section_age_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">post_section_ages</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">section</span> <span class="o">+</span> <span class="s1">&#39;_ages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
            <span class="n">section_sample_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">post_section_ages</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">age_heights</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>

                <span class="n">above</span> <span class="o">=</span> <span class="n">intermediate_intrusive_section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">age_heights</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>
                <span class="n">below</span> <span class="o">=</span> <span class="n">intermediate_intrusive_section_ages_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">age_heights</span><span class="p">[</span><span class="n">interval</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">intrusive_interval_df</span> <span class="o">=</span> <span class="n">intermediate_intrusive_section_ages_df</span><span class="p">[</span><span class="n">above</span> <span class="o">&amp;</span> <span class="n">below</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">height</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">intrusive_interval_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">intrusive_interval_df</span><span class="p">[</span><span class="s1">&#39;shared?&#39;</span><span class="p">],</span> <span class="n">intrusive_interval_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">intrusive_interval_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">section_df</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">height</span>

                    <span class="c1"># check that all the posterior ages for overlying samples are younger than the detrital age during each draw</span>
                    <span class="k">if</span> <span class="n">shared</span><span class="p">:</span>
                        <span class="n">intrusive_age_posterior</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;intrusive_age_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">intrusive_age_posterior</span> <span class="o">=</span> <span class="n">full_trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">dist_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:]</span>

                    <span class="k">for</span> <span class="n">draw</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">section_sample_ages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># assert all(section_sample_ages[:, draw][sample_idx] &gt;= intrusive_age_posterior[draw])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">section_sample_ages</span><span class="p">[:,</span> <span class="n">draw</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">intrusive_age_posterior</span><span class="p">[</span><span class="n">draw</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Intrusive age constraint violated in section &#39;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, chain &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="o">+</span>  <span class="s2">&quot;, draw &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">draw</span><span class="p">))</span>
                            <span class="n">bad_chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">bad_chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bad_chains</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bad_chains</span></div>

</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, Stacey Edmonsond.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>